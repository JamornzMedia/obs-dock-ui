<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBSCam Sender V2.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            background: #050505;
            color: white;
            touch-action: manipulation;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* แก้ให้ Scroll ได้ในแนวนอน */
        #setup {
            height: 100vh;
            overflow-y: auto;
            position: relative;
            z-index: 50;
            padding-bottom: 50px;
        }

        .video-full {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translateZ(0);
        }

        .zoom-wrapper {
            position: absolute;
            right: 80px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 40;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 20px;
            padding: 10px 5px;
            backdrop-filter: blur(2px);
        }

        input[type=range][orient=vertical] {
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            width: 8px;
            height: 150px;
            padding: 0 5px;
        }

        .right-bar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            pointer-events: auto;
            z-index: 50;
            background: linear-gradient(to left, rgba(0, 0, 0, 0.5), transparent);
        }

        .ui-rotate-90 {
            transform: rotate(90deg);
            width: 100vh !important;
            height: 100vw !important;
            top: 50% !important;
            left: 50% !important;
            translate: -50% -50%;
        }

        .simple-logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .logo-main {
            font-size: 3rem;
            font-weight: 900;
            font-style: italic;
            letter-spacing: -2px;
            line-height: 1;
            background: -webkit-linear-gradient(#fff, #999);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-sub {
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 4px;
            color: #666;
            margin-top: -5px;
        }

        .fade-ui {
            transition: opacity 0.3s ease;
        }

        .ui-hidden {
            opacity: 0;
            pointer-events: none;
        }

        /* Modal Styles */
        .settings-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease;
            transform: translateY(100%);
        }

        .settings-modal.active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div id="setup" class="p-6 flex flex-col items-center bg-slate-950">
        <button onclick="toggleSettingsModal(true)"
            class="absolute top-4 right-4 bg-gray-800 text-gray-300 hover:text-white px-3 py-2 rounded-lg text-xs font-bold border border-gray-700">
            <i class="fas fa-cog mr-1"></i> SETTINGS
        </button>

        <button onclick="toggleFullScreen()" class="absolute top-4 left-4 text-gray-500 hover:text-white"><i
                class="fas fa-expand text-xl"></i></button>

        <div class="simple-logo mt-10">
            <div class="logo-main">OBSCam</div>
            <div class="logo-sub">SENDER</div>
        </div>

        <div class="space-y-4 max-w-sm w-full mb-10">
            <div class="bg-gray-900 p-4 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Target Room ID</label>
                <div class="flex gap-2">
                    <input type="tel" id="room-id" placeholder="######" maxlength="6" onkeyup="checkRoomConfig()"
                        class="w-full bg-black border border-gray-700 p-3 rounded-lg text-center text-3xl font-mono text-green-400 font-bold outline-none placeholder-gray-800 tracking-widest">
                    <button onclick="startQRScanner()"
                        class="bg-gray-800 w-16 rounded-lg flex items-center justify-center text-blue-400 hover:bg-gray-700 active:scale-95 transition"><i
                            class="fas fa-qrcode text-2xl"></i></button>
                </div>
                <div id="setup-room-name" class="hidden mt-2 text-center">
                    <span class="text-green-400 text-sm font-bold"><i class="fas fa-check-circle mr-1"></i><span
                            id="setup-room-name-text"></span></span>
                </div>
            </div>

            <div class="bg-blue-900/20 p-4 rounded-xl border border-blue-500/30">
                <label class="text-[10px] text-blue-300 font-bold uppercase block mb-1">Send To (Slot)</label>
                <select id="cam-index"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-blue-500/50 outline-none font-bold">
                    <option value="1">CAMERA 1</option>
                    <option value="2">CAMERA 2</option>
                    <option value="3">CAMERA 3</option>
                    <option value="4">CAMERA 4</option>
                </select>
            </div>

            <button onclick="startStreaming()"
                class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-xl shadow-lg active:scale-95 transition-transform text-white mb-4 mt-2">
                START STREAMING
            </button>

            <div class="text-center pt-2">
                <p class="text-[10px] text-gray-500">Developed by <a href="https://easydonate.app/Jamornz"
                        target="_blank"
                        class="text-blue-400 font-bold hover:underline hover:text-blue-300">JamornzMedia</a></p>
                <p class="text-[9px] text-gray-600">OBSCam V2.4</p>
            </div>
        </div>
    </div>

    <div id="settings-ui" class="settings-modal overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-sliders-h mr-2"></i> Settings</h2>
            <button onclick="toggleSettingsModal(false)" class="text-gray-400 hover:text-white text-lg"><i
                    class="fas fa-times"></i></button>
        </div>

        <div class="space-y-4 max-w-sm w-full mx-auto">
            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Select Camera</label>
                <select id="camera-select"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-gray-700 outline-none">
                    <option value="">Default (Rear/Auto)</option>
                </select>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Select Audio Input (Mic)</label>
                <select id="audio-source"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-gray-700 outline-none">
                    <option value="">Default (Auto)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Res</label>
                    <select id="res" class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                        <option value="1080">1080p</option>
                        <option value="720" selected>720p</option>
                        <option value="480">480p</option>
                    </select>
                </div>
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">FPS</label>
                    <select id="fps" class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                        <option value="30" selected>30</option>
                        <option value="60">60</option>
                    </select>
                </div>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Bitrate</label>
                <select id="bitrate" class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700"
                    onchange="checkCustomBitrate(this)">
                    <option value="2000">2.0 M</option>
                    <option value="2500" selected>2.5 M</option>
                    <option value="3000">3.0 M</option>
                    <option value="3500">3.5 M</option>
                    <option value="4000">4.0 M</option>
                    <option value="6000">6.0 M</option>
                    <option value="8500">8.5 M</option>
                    <option value="10000">10 M</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Audio Start State</label>
                <select id="audio-enable"
                    class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                    <option value="false">Mute on Start</option>
                    <option value="true" selected>Unmute on Start</option>
                </select>
            </div>

            <button onclick="toggleSettingsModal(false)"
                class="w-full bg-green-600 hover:bg-green-500 py-3 rounded-lg font-bold text-white mt-4">DONE</button>
        </div>
    </div>

    <div id="live-ui" class="hidden absolute inset-0 bg-black z-0 transition-transform duration-300"
        onclick="toggleUI(event)">
        <video id="preview" class="video-full" autoplay playsinline muted></video>

        <div id="grid-layer"
            class="grid-lines hidden absolute inset-0 grid grid-cols-3 grid-rows-3 pointer-events-none z-10">
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
            <div class="border border-white/20"></div>
        </div>

        <div id="overlay-controls" class="absolute inset-0 pointer-events-none fade-ui z-20">
            <div class="absolute top-4 left-4 flex flex-col gap-2 pointer-events-auto">
                <div class="bg-black/60 px-3 py-1.5 rounded-md border-l-4 border-green-500 backdrop-blur-sm">
                    <div class="flex items-center gap-2">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
                        <span id="status-txt"
                            class="text-sm text-green-400 font-bold tracking-wide">CONNECTING...</span>
                    </div>
                    <div class="text-[10px] text-white font-mono mt-0.5" id="room-info">Room: ----</div>
                    <div id="live-room-name" class="hidden text-[11px] text-blue-300 font-bold mt-0.5"></div>
                </div>

                <div class="flex gap-2">
                    <div id="realtime-bw"
                        class="bg-black/40 px-2 py-0.5 rounded text-[10px] text-green-300 font-mono w-fit">0 kbps</div>
                    <div id="battery-stat"
                        class="bg-black/40 px-2 py-0.5 rounded text-[10px] text-yellow-300 font-mono w-fit"><i
                            class="fas fa-bolt"></i> --%</div>
                </div>

                <select id="live-bitrate" onchange="updateLiveBitrate(this.value)"
                    class="bg-black/60 text-white text-[10px] h-8 px-2 rounded-lg border border-white/20 outline-none backdrop-blur mt-1 w-24">
                    <option value="2000">2.0 M</option>
                    <option value="2500">2.5 M</option>
                    <option value="3000">3.0 M</option>
                    <option value="3500">3.5 M</option>
                    <option value="4000">4.0 M</option>
                    <option value="6000">6.0 M</option>
                    <option value="8500">8.5 M</option>
                    <option value="10000">10 M</option>
                </select>
            </div>

            <div id="zoom-container" class="hidden zoom-wrapper pointer-events-auto">
                <i class="fas fa-plus text-[10px] text-white mb-2"></i>
                <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1"
                    oninput="applyZoom(this.value)" style="height: 120px; width: 6px; appearance: slider-vertical;">
                <i class="fas fa-minus text-[10px] text-white mt-2"></i>
            </div>

            <div class="absolute bottom-6 left-6 flex gap-3 items-center pointer-events-auto">
                <button onclick="stopStreaming()"
                    class="bg-red-600/90 w-12 h-12 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition text-white border-2 border-red-400/50"><i
                        class="fas fa-stop text-lg"></i></button>
                <button onclick="reconnectSignaling()"
                    class="bg-yellow-500/80 w-10 h-10 rounded-full flex items-center justify-center shadow active:scale-90 transition text-white"><i
                        class="fas fa-sync text-sm"></i></button>
            </div>

            <div class="absolute bottom-6 right-24 pointer-events-auto">
                <select id="live-cam-select" onchange="switchCamera(this.value)"
                    class="bg-black/60 text-white text-[10px] h-10 px-3 rounded-lg border border-white/20 outline-none backdrop-blur shadow-lg">
                    <option value="">Change Lens...</option>
                </select>
            </div>

            <div class="right-bar">
                <button onclick="toggleFullScreen()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-blue-500 text-white"><i
                        class="fas fa-expand"></i></button>
                <button onclick="rotateUI()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-blue-500 text-white"><i
                        class="fas fa-redo"></i></button>
                <button onclick="toggleTorch()" id="torch-btn"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-yellow-500 text-white"><i
                        class="fas fa-bolt"></i></button>
                <button onclick="toggleMic()" id="mic-btn"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-green-500 text-white"><i
                        class="fas fa-microphone"></i></button>
                <button onclick="triggerAutoFocus()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-blue-500 text-white"><i
                        class="fas fa-crosshairs"></i></button>
                <button onclick="toggleGrid()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-purple-500 text-white"><i
                        class="fas fa-border-all"></i></button>
            </div>
        </div>
    </div>

    <div id="qr-overlay" class="hidden fixed inset-0 bg-black z-[100] flex flex-col items-center justify-center">
        <video id="qr-video" class="absolute inset-0 w-full h-full object-cover"></video>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div
                class="w-64 h-64 border-4 border-blue-500 rounded-2xl relative shadow-[0_0_100px_rgba(59,130,246,0.5)]">
            </div>
        </div>
        <button onclick="stopQRScanner()"
            class="absolute bottom-10 bg-red-600 px-8 py-3 rounded-full font-bold shadow-lg z-20 text-white">CANCEL</button>
        <canvas id="qr-canvas" hidden></canvas>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCRpQWN6J1HYE4r5R8YC2od0ZBt_gSm-iQ", authDomain: "obscam-p2p.firebaseapp.com", databaseURL: "https://obscam-p2p-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "obscam-p2p", appId: "1:531335072084:web:dc373db6b66581a63160c1" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.relay.metered.ca:80' },
                { urls: 'turn:global.relay.metered.ca:80', username: '8d112b2afeb44b3e5b95078c', credential: '7aoALRnThKJC0xNo' },
                { urls: 'turn:global.relay.metered.ca:80?transport=tcp', username: '8d112b2afeb44b3e5b95078c', credential: '7aoALRnThKJC0xNo' },
                { urls: 'turn:global.relay.metered.ca:443', username: '8d112b2afeb44b3e5b95078c', credential: '7aoALRnThKJC0xNo' },
                { urls: 'turns:global.relay.metered.ca:443?transport=tcp', username: '8d112b2afeb44b3e5b95078c', credential: '7aoALRnThKJC0xNo' }
            ],
            iceTransportPolicy: 'all'
        };

        let pcs = { monitor: null, obs: null };
        let dcs = { monitor: null };
        let myStream, videoTrack, audioTrack, qrStream;
        let customBitrateVal = 2500, targetCamIndex = "1", roomId = "";
        let isUIRotated = false, statsInterval = null;
        let lastBytes = { obs: 0, monitor: 0 };
        let lastTime = 0;
        let sessionTotalBytes = 0;
        let monitorBitrateTarget = 50;
        let currentMaxCams = 4;
        let currentRoomName = '';

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');

        initDeviceSelection().then(() => { loadSettings(); });

        async function initDeviceSelection() {
            try {
                // Request temp permission to see labels
                const tmpStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                tmpStream.getTracks().forEach(track => track.stop());

                const videoSelect = document.getElementById('camera-select');
                const liveSelect = document.getElementById('live-cam-select');
                const audioSelect = document.getElementById('audio-source');

                videoSelect.innerHTML = '<option value="">Default (Rear/Auto)</option>';
                liveSelect.innerHTML = '<option value="">Change Lens...</option>';
                audioSelect.innerHTML = '<option value="">Default (Auto)</option>';

                let vCount = 1, aCount = 1;
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const label = device.label || `Camera ${vCount++}`;
                        const option = new Option(label, device.deviceId);
                        videoSelect.appendChild(option);
                        liveSelect.appendChild(option.cloneNode(true));
                    } else if (device.kind === 'audioinput') {
                        const label = device.label || `Microphone ${aCount++}`;
                        const option = new Option(label, device.deviceId);
                        audioSelect.appendChild(option);
                    }
                });
            } catch (e) { console.log("Permission Error", e); }
        }

        function toggleSettingsModal(show) {
            const modal = document.getElementById('settings-ui');
            if (show) modal.classList.add('active');
            else modal.classList.remove('active');
        }

        function loadSettings() {
            if (roomFromUrl) {
                document.getElementById('room-id').value = roomFromUrl;
                checkRoomConfig();
            } else if (localStorage.getItem('obs_room_id')) {
                document.getElementById('room-id').value = localStorage.getItem('obs_room_id');
                checkRoomConfig();
            }
            if (localStorage.getItem('obs_cam_index')) document.getElementById('cam-index').value = localStorage.getItem('obs_cam_index');
            if (localStorage.getItem('obs_camera_id')) document.getElementById('camera-select').value = localStorage.getItem('obs_camera_id');
            if (localStorage.getItem('obs_audio_id')) document.getElementById('audio-source').value = localStorage.getItem('obs_audio_id');

            if (localStorage.getItem('obs_bitrate')) {
                const b = localStorage.getItem('obs_bitrate');
                const sel = document.getElementById('bitrate');
                if (b === 'custom' && localStorage.getItem('obs_custom_bitrate')) {
                    customBitrateVal = parseInt(localStorage.getItem('obs_custom_bitrate'));
                    sel.options[sel.options.length - 1].text = `Custom (${customBitrateVal})`;
                    sel.value = 'custom';
                } else { sel.value = b; }
            }
        }

        function checkRoomConfig() {
            const rId = document.getElementById('room-id').value;
            const setupNameDiv = document.getElementById('setup-room-name');
            const setupNameText = document.getElementById('setup-room-name-text');

            if (rId.length >= 6) {
                db.ref(`OBSCam_rooms/${rId}/config/maxCams`).once('value').then(snap => {
                    if (snap.exists()) {
                        const max = snap.val();
                        currentMaxCams = max;
                        const sel = document.getElementById('cam-index');
                        const currentVal = sel.value;
                        sel.innerHTML = '';
                        for (let i = 1; i <= max; i++) {
                            const opt = document.createElement('option');
                            opt.value = i;
                            opt.text = `CAMERA ${i}`;
                            sel.appendChild(opt);
                        }
                        if (currentVal <= max) sel.value = currentVal;

                        // Fetch room name
                        db.ref(`OBSCam_rooms/${rId}/config/roomName`).once('value').then(nameSnap => {
                            if (nameSnap.exists() && nameSnap.val()) {
                                currentRoomName = nameSnap.val();
                                setupNameText.innerText = currentRoomName;
                                setupNameDiv.classList.remove('hidden');
                            } else {
                                currentRoomName = '';
                                setupNameDiv.classList.add('hidden');
                            }
                        });
                    } else {
                        setupNameDiv.classList.add('hidden');
                    }
                });
            } else {
                setupNameDiv.classList.add('hidden');
            }
        }

        function saveSettings() {
            localStorage.setItem('obs_room_id', document.getElementById('room-id').value);
            localStorage.setItem('obs_cam_index', document.getElementById('cam-index').value);
            localStorage.setItem('obs_bitrate', document.getElementById('bitrate').value);
            localStorage.setItem('obs_camera_id', document.getElementById('camera-select').value);
            localStorage.setItem('obs_audio_id', document.getElementById('audio-source').value);
            if (document.getElementById('bitrate').value === 'custom') localStorage.setItem('obs_custom_bitrate', customBitrateVal);
        }

        function checkCustomBitrate(el) {
            if (el.value === 'custom') {
                const val = prompt("Bitrate (kbps):", customBitrateVal);
                if (val && !isNaN(val)) {
                    customBitrateVal = parseInt(val);
                    el.options[el.options.length - 1].text = `Custom (${val})`;
                } else { el.value = "2500"; }
            }
        }

        async function startStreaming() {
            if (myStream) {
                myStream.getTracks().forEach(track => track.stop());
                myStream = null;
            }

            saveSettings();
            roomId = document.getElementById('room-id').value;
            if (roomId.length < 6) return alert('Invalid Room ID');

            document.getElementById('room-info').innerText = "Room: " + roomId;
            document.getElementById('status-txt').innerText = "CHECKING...";

            // Show room name in live UI if available
            const liveNameEl = document.getElementById('live-room-name');
            if (currentRoomName) {
                liveNameEl.innerText = currentRoomName;
                liveNameEl.classList.remove('hidden');
            } else {
                liveNameEl.classList.add('hidden');
            }

            const roomSnap = await db.ref(`OBSCam_rooms/${roomId}/active`).get();
            if (!roomSnap.exists()) { alert(`Room ${roomId} not found!`); return; }

            // Validate Slot
            targetCamIndex = document.getElementById('cam-index').value;
            if (parseInt(targetCamIndex) > currentMaxCams) {
                alert(`Error: This room only supports ${currentMaxCams} cameras. Please refresh or select a lower slot.`);
                checkRoomConfig();
                return;
            }

            document.getElementById('status-txt').innerText = `LIVE : CAM ${targetCamIndex}`;
            document.getElementById('status-dot').className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";

            const quality = parseInt(document.getElementById('res').value);
            const fpsVal = parseInt(document.getElementById('fps').value);
            const selectedCamId = document.getElementById('camera-select').value;
            const selectedAudioId = document.getElementById('audio-source').value;
            const startUnmuted = document.getElementById('audio-enable').value === 'true';

            // Init Mic Button State
            const micBtn = document.getElementById('mic-btn');
            if (startUnmuted) {
                micBtn.classList.remove('bg-red-500'); micBtn.classList.add('bg-green-500'); micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            } else {
                micBtn.classList.remove('bg-green-500'); micBtn.classList.add('bg-red-500'); micBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
            }

            const currentBitrateSet = document.getElementById('bitrate').value;
            const liveBitSel = document.getElementById('live-bitrate');
            if (currentBitrateSet === 'custom') {
                let opt = new Option(`Custom (${customBitrateVal})`, customBitrateVal);
                liveBitSel.add(opt);
                liveBitSel.value = customBitrateVal;
            } else { liveBitSel.value = currentBitrateSet; }

            let videoConstraints = { width: { ideal: quality * 1.777 }, height: { ideal: quality }, frameRate: { ideal: fpsVal } };
            if (selectedCamId) videoConstraints.deviceId = { exact: selectedCamId }; else videoConstraints.facingMode = 'environment';

            // Audio Constraints
            let audioConstraints = true;
            if (selectedAudioId) {
                audioConstraints = { deviceId: { exact: selectedAudioId } };
            }

            try {
                try { myStream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints, video: videoConstraints }); }
                catch (err) { delete videoConstraints.facingMode; delete videoConstraints.deviceId; myStream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints, video: videoConstraints }); }

                videoTrack = myStream.getVideoTracks()[0];
                audioTrack = myStream.getAudioTracks()[0];

                if (audioTrack) audioTrack.enabled = startUnmuted;

                document.getElementById('preview').srcObject = myStream;
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('live-ui').classList.remove('hidden');
                checkZoomCapabilities();

                db.ref(`OBSCam_rooms/${roomId}/cam${targetCamIndex}`).onDisconnect().remove();

                connectToPath(roomId, targetCamIndex, 'obs');
                connectToPath(roomId, targetCamIndex, 'monitor');

                listenMonitorControl(roomId, targetCamIndex);
                startUpdatingStatsLocal(quality, fpsVal);

            } catch (e) { alert('Camera/Mic Error: ' + e.message); }
        }

        function toggleMic() {
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                const micBtn = document.getElementById('mic-btn');
                if (audioTrack.enabled) {
                    micBtn.classList.remove('bg-red-500'); micBtn.classList.add('bg-green-500'); micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                } else {
                    micBtn.classList.remove('bg-green-500'); micBtn.classList.add('bg-red-500'); micBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                }
            }
        }

        function toggleFullScreen() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(e => { console.log(e); }); }
            else { if (document.exitFullscreen) document.exitFullscreen(); }
        }

        function toggleUI(e) {
            if (e.target.tagName === 'BUTTON' || e.target.closest('button') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            document.getElementById('overlay-controls').classList.toggle('ui-hidden');
        }

        function updateLiveBitrate(val) {
            if (!isNaN(val)) customBitrateVal = parseInt(val);
            if (pcs.obs) setBitrate(pcs.obs, parseInt(val) * 1000);
            updateMonitorBitrate();
        }

        function listenMonitorControl(rid, cIdx) {
            const controlRef = db.ref(`OBSCam_rooms/${rid}/cam${cIdx}/monitorControl`);
            // Removed: unnecessary initial update - Monitor will set initial values

            controlRef.on('value', snap => {
                const val = snap.val();
                if (val) {
                    const shouldEnableVideo = val.enabled;
                    monitorBitrateTarget = val.bitratePercent || 50;
                    if (pcs.monitor) {
                        const sender = pcs.monitor.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender && sender.track) {
                            sender.track.enabled = shouldEnableVideo;
                        }
                        if (shouldEnableVideo) updateMonitorBitrate();
                        else setBitrate(pcs.monitor, 50000);
                    }
                }
            });
        }

        function stopStreaming() {
            if (myStream) myStream.getTracks().forEach(track => track.stop());
            if (pcs.monitor) pcs.monitor.close();
            if (pcs.obs) pcs.obs.close();
            pcs = { monitor: null, obs: null };
            dcs = { monitor: null };
            clearInterval(statsInterval);

            if (roomId && targetCamIndex) {
                db.ref(`OBSCam_rooms/${roomId}/cam${targetCamIndex}/monitorControl`).off();
                db.ref(`OBSCam_rooms/${roomId}/cam${targetCamIndex}`).remove();
                db.ref(`OBSCam_rooms/${roomId}/cam${targetCamIndex}`).onDisconnect().cancel();
            }

            document.getElementById('live-ui').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
            sessionTotalBytes = 0;
        }

        function getTargetBitrate() { return parseInt(document.getElementById('live-bitrate').value) || 2500; }

        function updateMonitorBitrate() {
            if (!pcs.monitor) return;
            setBitrate(pcs.monitor, monitorBitrateTarget * 1000);
        }

        function preferCodec(sdp, codec) {
            var sdpLines = sdp.split('\r\n');
            var mLineIndex = -1;
            for (var i = 0; i < sdpLines.length; i++) { if (sdpLines[i].search('m=video') !== -1) { mLineIndex = i; break; } }
            if (mLineIndex === -1) return sdp;
            var codecPayload = null;
            var pattern = new RegExp(":(\\d+) " + codec + "/90000");
            for (var i = 0; i < sdpLines.length; i++) { var result = sdpLines[i].match(pattern); if (result) { codecPayload = result[1]; break; } }
            if (!codecPayload) return sdp;
            var mLine = sdpLines[mLineIndex];
            var elements = mLine.split(' ');
            var newMLine = elements.slice(0, 3);
            newMLine.push(codecPayload);
            for (var i = 3; i < elements.length; i++) { if (elements[i] !== codecPayload) newMLine.push(elements[i]); }
            sdpLines[mLineIndex] = newMLine.join(' ');
            return sdpLines.join('\r\n');
        }

        async function connectToPath(rid, cIdx, type) {
            const roomRef = db.ref(`OBSCam_rooms/${rid}/cam${cIdx}/${type}`);
            const pc = new RTCPeerConnection(rtcConfig);
            pcs[type] = pc;

            if (type === 'monitor') {
                const dc = pc.createDataChannel("stats");
                dcs.monitor = dc;
            }

            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

            if (type === 'monitor') {
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) sender.track.enabled = false;
            }

            // ICE Candidate Batching — เก็บ candidates แล้วส่งทีเดียว ลด Firebase writes ~90%
            let pendingCandidates = [];
            pc.onicecandidate = event => {
                if (event.candidate) {
                    pendingCandidates.push(event.candidate.toJSON());
                } else {
                    // ICE gathering complete → ส่งทีเดียว
                    if (pendingCandidates.length > 0) {
                        roomRef.child('callerCandidates').set(pendingCandidates);
                        console.log(`[ICE] ${type}: sent ${pendingCandidates.length} candidates (batched)`);
                    }
                }
            };

            // ICE Connection State Monitoring + Auto-Reconnect
            pc.oniceconnectionstatechange = () => {
                const state = pc.iceConnectionState;
                console.log(`[ICE] ${type}: ${state}`);
                if (state === 'connected' || state === 'completed') {
                    document.getElementById('status-txt').innerText = `LIVE : CAM ${targetCamIndex}`;
                    document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                } else if (state === 'disconnected') {
                    document.getElementById('status-txt').innerText = `RECONNECTING...`;
                    document.getElementById('status-dot').className = 'w-2 h-2 rounded-full bg-yellow-400 animate-pulse';
                } else if (state === 'failed') {
                    console.log(`[ICE] ${type}: connection failed, attempting reconnect...`);
                    document.getElementById('status-txt').innerText = `RECONNECTING...`;
                    // Auto-reconnect: redo ICE negotiation
                    pc.restartIce();
                    pc.createOffer({ iceRestart: true }).then(async newOffer => {
                        const sdpH264 = preferCodec(newOffer.sdp, 'H264');
                        newOffer = new RTCSessionDescription({ type: 'offer', sdp: sdpH264 });
                        await pc.setLocalDescription(newOffer);
                        await roomRef.child('offer').set({ sdp: newOffer.sdp, type: newOffer.type });
                    }).catch(e => console.error('[ICE] restart failed:', e));
                }
            };

            let offer = await pc.createOffer();
            const sdpH264 = preferCodec(offer.sdp, 'H264');
            offer = new RTCSessionDescription({ type: 'offer', sdp: sdpH264 });

            await pc.setLocalDescription(offer);
            await roomRef.child('offer').set({ sdp: offer.sdp, type: offer.type });

            roomRef.child('answer').on('value', async snapshot => {
                const data = snapshot.val();
                if (!data) return;
                if (!pc.currentRemoteDescription) await pc.setRemoteDescription(new RTCSessionDescription(data));
            });

            // รับ calleeCandidates แบบ array (batched) จาก receiver
            roomRef.child('calleeCandidates').on('value', snapshot => {
                const candidates = snapshot.val();
                if (candidates && Array.isArray(candidates)) {
                    candidates.forEach(c => { if (c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(e => { }); });
                }
            });

            if (type === 'obs') {
                const bps = getTargetBitrate() * 1000;
                setBitrate(pc, bps);
            } else {
                updateMonitorBitrate();
            }
        }

        function setBitrate(pc, bitrate) {
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender && sender.getParameters) {
                const params = sender.getParameters();
                if (!params.encodings) params.encodings = [{}];
                params.encodings[0].maxBitrate = bitrate;
                // ตั้ง floor ไม่ให้ bitrate ต่ำกว่า 50% ของ target
                if (bitrate > 100000) params.encodings[0].minBitrate = Math.floor(bitrate * 0.5);
                // ลด fps แทนลด resolution → ภาพชัดขึ้น
                params.encodings[0].degradationPreference = 'maintain-resolution';
                sender.setParameters(params).catch(e => console.log(e));
            }
        }

        function startUpdatingStatsLocal(resH, fps) {
            lastBytes = { obs: 0, monitor: 0 };
            lastTime = Date.now();
            sessionTotalBytes = 0;

            statsInterval = setInterval(async () => {
                let obsBytes = 0, monBytes = 0;

                if (pcs.obs && pcs.obs.connectionState === 'connected') {
                    const s = await pcs.obs.getStats();
                    s.forEach(r => { if (r.type === 'outbound-rtp' && r.kind === 'video') obsBytes += r.bytesSent; });
                }
                if (pcs.monitor && pcs.monitor.connectionState === 'connected') {
                    const s = await pcs.monitor.getStats();
                    s.forEach(r => { if (r.type === 'outbound-rtp' && r.kind === 'video') monBytes += r.bytesSent; });
                }

                const now = Date.now();
                const diffTime = now - lastTime;
                let mainKbps = 0, monKbps = 0;

                if (diffTime > 0) {
                    if (obsBytes > 0 && lastBytes.obs > 0) mainKbps = Math.round(((obsBytes - lastBytes.obs) * 8) / diffTime);
                    if (monBytes > 0 && lastBytes.monitor > 0) monKbps = Math.round(((monBytes - lastBytes.monitor) * 8) / diffTime);

                    const diffMain = (obsBytes > lastBytes.obs) ? (obsBytes - lastBytes.obs) : 0;
                    const diffMon = (monBytes > lastBytes.monitor) ? (monBytes - lastBytes.monitor) : 0;
                    sessionTotalBytes += (diffMain + diffMon);
                }

                lastBytes.obs = obsBytes;
                lastBytes.monitor = monBytes;
                lastTime = now;

                document.getElementById('realtime-bw').innerText = `${mainKbps} kbps`;

                let batLevel = 100;
                try {
                    const battery = await navigator.getBattery();
                    batLevel = Math.round(battery.level * 100);
                    document.getElementById('battery-stat').innerHTML = `<i class="fas fa-bolt"></i> ${batLevel}%`;
                } catch (e) { }

                if (dcs.monitor && dcs.monitor.readyState === 'open') {
                    const payload = {
                        res: resH + "p",
                        fps: fps,
                        mainKbps: mainKbps,
                        monKbps: monKbps,
                        bat: batLevel,
                        totalData: (sessionTotalBytes / (1024 * 1024)).toFixed(1)
                    };
                    dcs.monitor.send(JSON.stringify(payload));
                }

            }, 1000);
        }

        async function checkZoomCapabilities() {
            if (!videoTrack) return;
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.zoom) {
                const slider = document.getElementById('zoom-slider');
                slider.min = capabilities.zoom.min; slider.max = capabilities.zoom.max; slider.step = capabilities.zoom.step; slider.value = capabilities.zoom.min;
                document.getElementById('zoom-container').classList.remove('hidden');
            } else { document.getElementById('zoom-container').classList.add('hidden'); }
        }
        async function applyZoom(value) { if (videoTrack) { try { await videoTrack.applyConstraints({ advanced: [{ zoom: value }] }); } catch (e) { } } }

        function rotateUI() {
            isUIRotated = !isUIRotated;
            const ui = document.getElementById('overlay-controls');
            if (isUIRotated) ui.classList.add('ui-rotate-90'); else ui.classList.remove('ui-rotate-90');
        }

        async function toggleTorch() { if (!videoTrack) return; try { const c = videoTrack.getSettings().torch || false; await videoTrack.applyConstraints({ advanced: [{ torch: !c }] }); document.getElementById('torch-btn').classList.toggle('bg-yellow-500'); } catch (e) { } }
        async function triggerAutoFocus() { if (!videoTrack) return; try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch (e) { } }
        function toggleGrid() { document.getElementById('grid-layer').classList.toggle('hidden'); }
        function reconnectSignaling() { if (roomId) { stopStreaming(); setTimeout(startStreaming, 1000); } }

        async function switchCamera(deviceId) {
            if (!deviceId || !myStream) return;
            try {
                myStream.getVideoTracks().forEach(t => t.stop());
                const quality = parseInt(document.getElementById('res').value);
                const fpsVal = parseInt(document.getElementById('fps').value);
                const audioEnable = document.getElementById('audio-enable').value === 'true';

                const newStream = await navigator.mediaDevices.getUserMedia({
                    audio: audioTrack && audioTrack.enabled, // Keep audio state
                    video: { deviceId: { exact: deviceId }, width: { ideal: quality * 1.777 }, height: { ideal: quality }, frameRate: { ideal: fpsVal } }
                });
                const newVideoTrack = newStream.getVideoTracks()[0];
                ['monitor', 'obs'].forEach(key => { if (pcs[key]) { const sender = pcs[key].getSenders().find(s => s.track.kind === 'video'); if (sender) sender.replaceTrack(newVideoTrack); } });

                // Audio Handling (Preserve audio track from initial stream if possible, or new stream)
                // In this simplified version, we just update video. Audio track remains from original if not stopped.

                videoTrack = newVideoTrack;

                // Reconstruct stream for preview
                let tracks = [newVideoTrack];
                if (audioTrack) tracks.push(audioTrack);
                myStream = new MediaStream(tracks);

                document.getElementById('preview').srcObject = myStream;
                checkZoomCapabilities();
                document.getElementById('live-cam-select').value = "";

            } catch (e) { alert("Switch failed: " + e); }
        }

        async function startQRScanner() {
            document.getElementById('qr-overlay').classList.remove('hidden');
            const video = document.getElementById('qr-video'); const canvas = document.getElementById('qr-canvas'); const ctx = canvas.getContext('2d');
            qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = qrStream; video.play(); requestAnimationFrame(tick);
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code && code.data.length >= 6) {
                        document.getElementById('room-id').value = code.data.replace(/\D/g, '').substring(0, 6);
                        stopQRScanner();
                        checkRoomConfig();
                    }
                }
                if (!document.getElementById('qr-overlay').classList.contains('hidden')) requestAnimationFrame(tick);
            }
        }
        function stopQRScanner() { document.getElementById('qr-overlay').classList.add('hidden'); if (qrStream) qrStream.getTracks().forEach(t => t.stop()); }
    </script>
</body>

</html>