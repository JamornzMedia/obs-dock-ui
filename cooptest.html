<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสหกรณ์ (Firebase Cloud)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out' },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-slate-50">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- Imports ---
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            Users, MapPin, Plus, Search, Home, FileText, 
            ChevronLeft, Navigation, Save, Phone, Map, Trash2, ClipboardPaste
        } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Firebase Config (ของคุณ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRpQWN6J1HYE4r5R8YC2od0ZBt_gSm-iQ",
            authDomain: "obscam-p2p.firebaseapp.com",
            databaseURL: "https://obscam-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obscam-p2p",
            storageBucket: "obscam-p2p.firebasestorage.app",
            messagingSenderId: "531335072084",
            appId: "1:531335072084:web:dc373db6b66581a63160c1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Components ---

        const Navbar = ({ view, navigateTo }) => (
            <div className="bg-blue-700 text-white p-4 sticky top-0 z-50 shadow-md">
                <div className="flex justify-between items-center max-w-lg mx-auto">
                    <div className="font-bold text-lg flex items-center gap-2 cursor-pointer" onClick={() => navigateTo('home')}>
                        <FileText size={24} />
                        <span>ระบบสหกรณ์ (Online)</span>
                    </div>
                    {view !== 'home' && (
                        <button onClick={() => navigateTo('home')} className="p-2 hover:bg-blue-600 rounded-full">
                            <Home size={20} />
                        </button>
                    )}
                </div>
            </div>
        );

        const HomeView = ({ membersCount, navigateTo }) => (
            <div className="space-y-6 animate-fade-in">
                <div className="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-2xl p-6 text-white shadow-lg">
                    <h2 className="text-2xl font-bold mb-1">ยินดีต้อนรับ</h2>
                    <p className="opacity-90">ระบบจัดการข้อมูลลูกหนี้ (เชื่อมต่อ Firebase)</p>
                    <div className="mt-6 flex items-center gap-4">
                        <div className="bg-white/20 p-3 rounded-xl backdrop-blur-sm">
                            <div className="text-3xl font-bold">{membersCount}</div>
                            <div className="text-xs">สมาชิกทั้งหมด</div>
                        </div>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => navigateTo('list')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col items-center gap-3 border border-gray-100">
                        <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Search size={24} /></div>
                        <span className="font-medium text-gray-700">ค้นหาข้อมูล</span>
                    </button>
                    <button onClick={() => navigateTo('add')} className="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col items-center gap-3 border border-gray-100">
                        <div className="bg-green-100 p-3 rounded-full text-green-600"><Plus size={24} /></div>
                        <span className="font-medium text-gray-700">เพิ่มรายชื่อ</span>
                    </button>
                </div>
            </div>
        );

        const ListView = ({ filteredMembers, searchTerm, setSearchTerm, navigateTo, isLoading }) => (
            <div className="space-y-4 animate-fade-in">
                <div className="flex items-center gap-2 mb-4">
                    <button onClick={() => navigateTo('home')} className="text-gray-500"><ChevronLeft /></button>
                    <h2 className="text-xl font-bold text-gray-800">รายชื่อสมาชิก</h2>
                </div>

                <div className="relative">
                    <input 
                        type="text"
                        placeholder="ค้นหา ชื่อ, สกุล หรือ เลขทะเบียน..."
                        className="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm"
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                    />
                    <Search className="absolute left-3 top-3.5 text-gray-400" size={20} />
                </div>

                <div className="space-y-3 pb-20">
                    {isLoading ? (
                        <div className="text-center py-10 text-gray-400">กำลังโหลดข้อมูล...</div>
                    ) : filteredMembers.length === 0 ? (
                        <div className="text-center py-10 text-gray-400">ไม่พบข้อมูล</div>
                    ) : (
                        filteredMembers.map(member => (
                            <div 
                                key={member.id}
                                onClick={() => navigateTo('detail', member)}
                                className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform"
                            >
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded font-medium">{member.regNo}</span>
                                        <span className="font-bold text-gray-800">{member.firstName} {member.lastName}</span>
                                    </div>
                                    <div className="text-sm text-gray-500 flex items-center gap-1">
                                        <MapPin size={12} />
                                        <span className="truncate max-w-[200px]">{member.address}</span>
                                    </div>
                                </div>
                                <ChevronLeft className="rotate-180 text-gray-300" />
                            </div>
                        ))
                    )}
                </div>
            </div>
        );

        const AddView = ({ formData, handleInputChange, handleSave, getCurrentLocation, handlePasteGPS, navigateTo, isSaving }) => (
            <div className="pb-10 animate-fade-in">
                <div className="flex items-center gap-2 mb-6">
                    <button onClick={() => navigateTo('home')} className="text-gray-500"><ChevronLeft /></button>
                    <h2 className="text-xl font-bold text-gray-800">เพิ่มสมาชิกใหม่</h2>
                </div>

                <form onSubmit={handleSave} className="space-y-4">
                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 space-y-4">
                        <h3 className="font-bold text-gray-700 border-b pb-2">ข้อมูลส่วนตัว</h3>
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">เลขทะเบียนสมาชิก</label>
                            <input required name="regNo" value={formData.regNo} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none" placeholder="เช่น 67001" />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-gray-600 mb-1">ชื่อ</label>
                                <input required name="firstName" value={formData.firstName} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-600 mb-1">นามสกุล</label>
                                <input required name="lastName" value={formData.lastName} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none" />
                            </div>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">เบอร์โทรศัพท์</label>
                            <input name="phone" value={formData.phone} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">ที่อยู่ปัจจุบัน</label>
                            <textarea required name="address" value={formData.address} onChange={handleInputChange} rows="2" className="w-full p-2 border rounded-lg bg-gray-50 outline-none" />
                        </div>
                    </div>

                    <div className="bg-white p-5 rounded-xl shadow-sm border border-gray-100 space-y-4">
                        <h3 className="font-bold text-gray-700 border-b pb-2 flex items-center gap-2">
                            <Map size={18} />
                            ข้อมูลหลักทรัพย์ค้ำประกัน
                        </h3>
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">ประเภทเอกสารสิทธิ์</label>
                            <select name="landType" value={formData.landType} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                                <option>โฉนดที่ดิน</option>
                                <option>น.ส.3 ก.</option>
                                <option>ส.ป.ก.</option>
                                <option>อื่นๆ</option>
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-600 mb-1">รายละเอียดที่ดิน</label>
                            <input name="landDesc" value={formData.landDesc} onChange={handleInputChange} className="w-full p-2 border rounded-lg bg-gray-50 outline-none" placeholder="เช่น 5 ไร่ 2 งาน บ้านพร้อมที่ดิน" />
                        </div>

                        {/* ส่วน GPS ใหม่ รองรับการวางข้อความ */}
                        <div className="p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <div className="flex justify-between items-center mb-2">
                                <label className="block text-sm font-bold text-blue-800">พิกัด GPS ที่ดิน</label>
                                <button type="button" onClick={getCurrentLocation} className="text-xs bg-blue-600 text-white px-2 py-1 rounded flex items-center gap-1 hover:bg-blue-700 transition-colors">
                                    <Navigation size={12} /> ดึงพิกัดปัจจุบัน
                                </button>
                            </div>

                            {/* ช่อง Quick Paste */}
                            <div className="mb-3 relative">
                                <input 
                                    type="text" 
                                    placeholder="วางพิกัดจาก Google Maps ที่นี่ (เช่น 17.050, 100.368)" 
                                    className="w-full p-2 pl-9 border border-blue-200 rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none text-blue-800 placeholder-blue-300"
                                    onChange={(e) => handlePasteGPS(e.target.value)}
                                />
                                <ClipboardPaste className="absolute left-2.5 top-2.5 text-blue-400" size={16} />
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <input placeholder="ละติจูด" name="gpsLat" value={formData.gpsLat} onChange={handleInputChange} className="w-full p-2 border rounded bg-white text-sm" />
                                <input placeholder="ลองจิจูด" name="gpsLng" value={formData.gpsLng} onChange={handleInputChange} className="w-full p-2 border rounded bg-white text-sm" />
                            </div>
                        </div>
                    </div>

                    <button disabled={isSaving} type="submit" className={`w-full text-white font-bold py-3 rounded-xl shadow-md flex justify-center items-center gap-2 transition-colors ${isSaving ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700'}`}>
                        <Save size={20} />
                        {isSaving ? 'กำลังบันทึก...' : 'บันทึกข้อมูล'}
                    </button>
                </form>
            </div>
        );

        const DetailView = ({ selectedMember, navigateTo, handleDelete }) => {
            if (!selectedMember) return null;
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${selectedMember.gpsLat},${selectedMember.gpsLng}`;

            return (
                <div className="pb-10 animate-fade-in">
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2">
                            <button onClick={() => navigateTo('list')} className="text-gray-500"><ChevronLeft /></button>
                            <h2 className="text-xl font-bold text-gray-800">ข้อมูลสมาชิก</h2>
                        </div>
                        {/* ปุ่มลบข้อมูล */}
                        <button 
                            onClick={() => handleDelete(selectedMember.id)}
                            className="bg-red-50 text-red-600 p-2 rounded-lg hover:bg-red-100 flex items-center gap-1 text-sm font-bold border border-red-200"
                        >
                            <Trash2 size={16} /> ลบข้อมูล
                        </button>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        <div className="bg-blue-600 p-6 text-white text-center">
                            <div className="w-20 h-20 bg-white/20 backdrop-blur rounded-full mx-auto flex items-center justify-center mb-3 text-2xl font-bold">
                                {selectedMember.firstName.charAt(0)}
                            </div>
                            <h1 className="text-2xl font-bold">{selectedMember.firstName} {selectedMember.lastName}</h1>
                            <p className="opacity-80">ทะเบียน: {selectedMember.regNo}</p>
                        </div>

                        <div className="p-6 space-y-6">
                            <div>
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">ข้อมูลติดต่อ</h3>
                                <div className="space-y-3">
                                    <div className="flex items-start gap-3">
                                        <MapPin className="text-blue-500 shrink-0 mt-1" size={18} />
                                        <span className="text-gray-700">{selectedMember.address}</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <Phone className="text-green-500 shrink-0" size={18} />
                                        <span className="text-gray-700">{selectedMember.phone || "-"}</span>
                                    </div>
                                </div>
                            </div>

                            <div className="border-t border-gray-100 my-4"></div>

                            <div>
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">หลักทรัพย์ค้ำประกัน</h3>
                                <div className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <div className="mb-2"><span className="text-xs text-gray-500 block">ประเภท</span><span className="font-medium text-gray-800">{selectedMember.landType}</span></div>
                                    <div className="mb-4"><span className="text-xs text-gray-500 block">รายละเอียด</span><span className="font-medium text-gray-800">{selectedMember.landDesc}</span></div>
                                    
                                    {selectedMember.gpsLat && selectedMember.gpsLng ? (
                                        <a href={mapUrl} target="_blank" rel="noreferrer" className="flex items-center justify-center gap-2 bg-blue-100 text-blue-700 py-3 rounded-lg font-bold hover:bg-blue-200 transition-colors w-full">
                                            <MapPin size={18} /> นำทางไปที่ดิน (Google Maps)
                                        </a>
                                    ) : (
                                        <div className="text-center text-gray-400 text-sm py-2">ไม่ระบุพิกัด GPS</div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Logic ---

        function App() {
            const [view, setView] = useState('home');
            const [members, setMembers] = useState([]);
            const [selectedMember, setSelectedMember] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            
            const [formData, setFormData] = useState({
                regNo: '', firstName: '', lastName: '', address: '', phone: '',
                landType: 'โฉนดที่ดิน', landDesc: '', gpsLat: '', gpsLng: ''
            });

            // 1. Load data from Firebase on start
            useEffect(() => {
                const membersRef = ref(db, 'members');
                // Realtime Listener: เมื่อข้อมูลใน Cloud เปลี่ยน หน้าจอจะเปลี่ยนตามทันที
                onValue(membersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        // แปลง Object ของ Firebase ให้เป็น Array
                        const memberList = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        setMembers(memberList.reverse()); // โชว์ตัวล่าสุดขึ้นก่อน
                    } else {
                        setMembers([]);
                    }
                    setIsLoading(false);
                });
            }, []);

            const navigateTo = (page, member = null) => {
                if (member) setSelectedMember(member);
                setView(page);
                window.scrollTo(0, 0);
            };

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            // 2. ฟังก์ชันแยก Lat/Lng อัตโนมัติเมื่อวางข้อความ
            const handlePasteGPS = (value) => {
                // ตัวอย่าง Input: "17.0501130, 100.3685701" หรือ "17.0501130,100.3685701"
                if (!value) return;
                
                // ลบช่องว่างออก และแยกด้วยเครื่องหมายลูกน้ำ (,)
                const cleanValue = value.replace(/\s/g, ''); 
                const parts = cleanValue.split(',');

                if (parts.length === 2) {
                    // ตรวจสอบว่าเป็นตัวเลขหรือไม่
                    const lat = parts[0];
                    const lng = parts[1];
                    
                    if(!isNaN(lat) && !isNaN(lng)) {
                        setFormData(prev => ({
                            ...prev,
                            gpsLat: lat,
                            gpsLng: lng
                        }));
                    }
                }
            };

            const getCurrentLocation = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            setFormData(prev => ({
                                ...prev,
                                gpsLat: position.coords.latitude.toFixed(6),
                                gpsLng: position.coords.longitude.toFixed(6)
                            }));
                            alert("ดึงพิกัดปัจจุบันเรียบร้อยแล้ว");
                        },
                        (error) => alert("ไม่สามารถดึงพิกัดได้: " + error.message)
                    );
                } else {
                    alert("Browser ไม่รองรับการระบุตำแหน่ง");
                }
            };

            // 3. Save to Firebase
            const handleSave = (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                // Push ข้อมูลใหม่ลงไปที่ node 'members'
                const membersRef = ref(db, 'members');
                push(membersRef, formData)
                    .then(() => {
                        alert("บันทึกข้อมูลลง Cloud เรียบร้อย!");
                        setFormData({
                            regNo: '', firstName: '', lastName: '', address: '', phone: '',
                            landType: 'โฉนดที่ดิน', landDesc: '', gpsLat: '', gpsLng: ''
                        });
                        setIsSaving(false);
                        navigateTo('list');
                    })
                    .catch((error) => {
                        alert("เกิดข้อผิดพลาดในการบันทึก: " + error.message);
                        setIsSaving(false);
                    });
            };

            // 4. Delete from Firebase
            const handleDelete = (id) => {
                if(confirm("คุณต้องการลบข้อมูลสมาชิกคนนี้อย่างถาวรใช่หรือไม่?")) {
                    const memberRef = ref(db, `members/${id}`);
                    remove(memberRef)
                        .then(() => {
                            alert("ลบข้อมูลเรียบร้อยแล้ว");
                            navigateTo('list');
                        })
                        .catch((error) => {
                            alert("ลบไม่สำเร็จ: " + error.message);
                        });
                }
            };

            const filteredMembers = members.filter(m => 
                (m.firstName && m.firstName.includes(searchTerm)) || 
                (m.lastName && m.lastName.includes(searchTerm)) || 
                (m.regNo && m.regNo.includes(searchTerm))
            );

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-gray-900 pb-10">
                    <Navbar view={view} navigateTo={navigateTo} />
                    <div className="max-w-lg mx-auto p-4">
                        {view === 'home' && (
                            <HomeView membersCount={members.length} navigateTo={navigateTo} />
                        )}
                        {view === 'list' && (
                            <ListView 
                                filteredMembers={filteredMembers} 
                                searchTerm={searchTerm} 
                                setSearchTerm={setSearchTerm} 
                                navigateTo={navigateTo}
                                isLoading={isLoading}
                            />
                        )}
                        {view === 'add' && (
                            <AddView 
                                formData={formData} 
                                handleInputChange={handleInputChange} 
                                handleSave={handleSave} 
                                getCurrentLocation={getCurrentLocation} 
                                handlePasteGPS={handlePasteGPS}
                                navigateTo={navigateTo}
                                isSaving={isSaving}
                            />
                        )}
                        {view === 'detail' && (
                            <DetailView 
                                selectedMember={selectedMember} 
                                navigateTo={navigateTo}
                                handleDelete={handleDelete}
                            />
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
