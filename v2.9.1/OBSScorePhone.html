<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBSScore Remote V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0f172a;
            color: white;
            touch-action: manipulation;
            user-select: none;
        }

        .btn-control {
            @apply active:scale-95 transition-transform shadow-lg flex items-center justify-center rounded-xl font-bold;
        }

        .page {
            display: none;
        }

        .page.active {
            display: flex;
        }

        input:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden flex flex-col">

    <!-- LOGIN SCREEN -->
    <div id="loginPage" class="page active flex-col items-center justify-center h-full p-6 space-y-6">
        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
            OBSScore Remote
        </h1>

        <div class="w-full max-w-sm bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-xl">
            <label class="block text-slate-400 text-sm mb-2">Room ID (from Desktop)</label>
            <input type="number" id="roomIdInput" placeholder="Enter 6-digit ID"
                class="w-full bg-slate-900 border border-slate-600 rounded-lg px-4 py-3 text-2xl text-center tracking-widest text-white mb-4 placeholder-slate-600">

            <button onclick="connectToHost()" id="connectBtn"
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all">
                CONNECT
            </button>
            <p id="statusMsg" class="text-center mt-3 text-slate-500 text-sm h-5"></p>
        </div>
    </div>

    <!-- CONTROL PANEL -->
    <div id="controlPage" class="page flex-col h-full bg-slate-900">
        <!-- HEADER -->
        <div class="h-16 bg-slate-800 flex items-center justify-between px-4 border-b border-slate-700">
            <div class="text-xs text-slate-400">
                <div id="connStatus" class="flex items-center gap-1 text-green-400">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div> Connected
                </div>
            </div>
            <div class="text-xl font-mono font-bold text-yellow-500" id="timerDisplay">00:00</div>
            <button onclick="disconnect()" class="text-red-400 hover:text-red-300 p-2"><i
                    class="fas fa-power-off"></i></button>
        </div>

        <!-- TEAMS -->
        <div class="flex-1 overflow-y-auto p-2 space-y-2">

            <!-- TEAM A -->
            <div class="bg-slate-800 rounded-xl p-3 border-l-4" id="teamABorder" style="border-color: #fff;">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="nameA" onchange="updateName('A', this.value)"
                        class="bg-transparent text-lg font-bold w-3/4 truncate focus:bg-slate-700 rounded px-1"
                        value="Team A">
                    <div class="flex space-x-1">
                        <div class="w-4 h-4 rounded-full" id="colorA1"></div>
                        <div class="w-4 h-4 rounded-full" id="colorA2"></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 h-16">
                    <button onclick="sendScore('A', -1, 'score')"
                        class="btn-control bg-red-500/20 text-red-500 border border-red-500/50 rounded-lg text-xl"><i
                            class="fas fa-minus"></i></button>
                    <div class="col-span-2 flex items-center justify-center bg-slate-900 rounded-lg text-4xl font-bold font-mono"
                        id="scoreA">0</div>
                    <button onclick="sendScore('A', 1, 'score')"
                        class="btn-control bg-green-500/20 text-green-500 border border-green-500/50 rounded-lg text-xl"><i
                            class="fas fa-plus"></i></button>
                </div>
                <!-- Yellow Cards -->
                <div class="grid grid-cols-4 gap-2 mt-2 h-10">
                    <div class="col-span-1 flex items-center justify-end text-xs text-yellow-500 pr-2">Cards:</div>
                    <button onclick="sendScore('A', -1, 'score2')"
                        class="btn-control bg-slate-700 text-slate-300 rounded">-</button>
                    <div class="flex items-center justify-center bg-slate-900 rounded font-mono font-bold text-yellow-500"
                        id="score2A">0</div>
                    <button onclick="sendScore('A', 1, 'score2')"
                        class="btn-control bg-slate-700 text-slate-300 rounded">+</button>
                </div>
            </div>

            <!-- TEAM B -->
            <div class="bg-slate-800 rounded-xl p-3 border-l-4" id="teamBBorder" style="border-color: #fff;">
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="nameB" onchange="updateName('B', this.value)"
                        class="bg-transparent text-lg font-bold w-3/4 truncate focus:bg-slate-700 rounded px-1"
                        value="Team B">
                    <div class="flex space-x-1">
                        <div class="w-4 h-4 rounded-full" id="colorB1"></div>
                        <div class="w-4 h-4 rounded-full" id="colorB2"></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-2 h-16">
                    <button onclick="sendScore('B', -1, 'score')"
                        class="btn-control bg-red-500/20 text-red-500 border border-red-500/50 rounded-lg text-xl"><i
                            class="fas fa-minus"></i></button>
                    <div class="col-span-2 flex items-center justify-center bg-slate-900 rounded-lg text-4xl font-bold font-mono"
                        id="scoreB">0</div>
                    <button onclick="sendScore('B', 1, 'score')"
                        class="btn-control bg-green-500/20 text-green-500 border border-green-500/50 rounded-lg text-xl"><i
                            class="fas fa-plus"></i></button>
                </div>
                <!-- Yellow Cards -->
                <div class="grid grid-cols-4 gap-2 mt-2 h-10">
                    <div class="col-span-1 flex items-center justify-end text-xs text-yellow-500 pr-2">Cards:</div>
                    <button onclick="sendScore('B', -1, 'score2')"
                        class="btn-control bg-slate-700 text-slate-300 rounded">-</button>
                    <div class="flex items-center justify-center bg-slate-900 rounded font-mono font-bold text-yellow-500"
                        id="score2B">0</div>
                    <button onclick="sendScore('B', 1, 'score2')"
                        class="btn-control bg-slate-700 text-slate-300 rounded">+</button>
                </div>
            </div>

            <!-- ACTIONS -->
            <div class="grid grid-cols-2 gap-2 mt-4">
                <button onclick="sendTimer('toggle')" id="playPauseBtn" class="btn-control bg-blue-600 h-14 text-xl"><i
                        class="fas fa-play"></i></button>
                <button onclick="sendCommand('SWAP')"
                    class="btn-control bg-purple-600 h-14 text-white font-bold text-sm">SWAP SIDES</button>
                <button onclick="sendCommand('INJURY', {delta: 1})"
                    class="btn-control bg-slate-700 h-10 text-sm text-green-400">+1 Injury</button>
                <button onclick="sendTimer('reset_start')"
                    class="btn-control bg-slate-700 h-10 text-sm text-yellow-400">Reset Time</button>
            </div>

            <div class="mt-4 text-center">
                <button onclick="sendCommand('HALF')"
                    class="bg-slate-800 px-4 py-2 rounded-lg text-slate-400 text-sm border border-slate-700"
                    id="halfDisplay">1st Half</button>
            </div>

        </div>
    </div>

    <script>
        let peer = null;
        let conn = null;
        let reconnectInterval = null;

        // Auto-connect from URL param
        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomId = urlParams.get('room');
        if (urlRoomId) {
            document.getElementById('roomIdInput').value = urlRoomId;
        }

        function connectToHost() {
            const roomId = document.getElementById('roomIdInput').value.trim();
            if (roomId.length !== 6) {
                showStatus("Invalid ID (must be 6 digits)", true);
                return;
            }

            showStatus("Connecting...", false);
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            if (peer) peer.destroy();

            peer = new Peer();
            peer.on('open', (id) => {
                const hostId = `fcp-v2-host-${roomId}`;
                console.log('My ID:', id, 'Connecting to:', hostId);
                conn = peer.connect(hostId);
                setupConnection();
            });

            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'peer-unavailable') {
                    showStatus("Room not found!", true);
                } else {
                    showStatus("Connection Error", true);
                }
                resetBtn();
            });
        }

        function setupConnection() {
            conn.on('open', () => {
                console.log('Connected!');
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('controlPage').classList.add('active');
            });

            conn.on('data', (data) => {
                console.log('Received:', data);
                if (data.type === 'UPDATE_STATE') {
                    updateUI(data);
                }
            });

            conn.on('close', () => {
                alert('Disconnected from Host');
                disconnect();
            });
        }

        function updateUI(state) {
            // Team A
            document.getElementById('nameA').value = state.teamA.name;
            document.getElementById('scoreA').textContent = state.teamA.score;
            document.getElementById('score2A').textContent = state.teamA.score2;
            document.getElementById('colorA1').style.backgroundColor = state.teamA.color1;
            document.getElementById('colorA2').style.backgroundColor = state.teamA.color2;
            document.getElementById('teamABorder').style.borderColor = state.teamA.color1;

            // Team B
            document.getElementById('nameB').value = state.teamB.name;
            document.getElementById('scoreB').textContent = state.teamB.score;
            document.getElementById('score2B').textContent = state.teamB.score2;
            document.getElementById('colorB1').style.backgroundColor = state.teamB.color1;
            document.getElementById('colorB2').style.backgroundColor = state.teamB.color2;
            document.getElementById('teamBBorder').style.borderColor = state.teamB.color1;

            // Global
            document.getElementById('timerDisplay').textContent = state.timer;
            if (state.timer.includes(':')) {
                if (state.isPaused) {
                    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
                    document.getElementById('playPauseBtn').classList.remove('bg-yellow-600');
                    document.getElementById('playPauseBtn').classList.add('bg-blue-600');
                } else {
                    document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                    document.getElementById('playPauseBtn').classList.remove('bg-blue-600');
                    document.getElementById('playPauseBtn').classList.add('bg-yellow-600');
                }
            }

            document.getElementById('halfDisplay').textContent = state.halfName || "Half"; // simplified
        }

        function sendScore(team, delta, target) {
            if (navigator.vibrate) navigator.vibrate(50);
            conn.send({ type: 'SCORE', team, delta, target });
        }

        function sendTimer(action) {
            if (navigator.vibrate) navigator.vibrate(50);
            conn.send({ type: 'TIMER', action });
        }

        function sendCommand(type, payload = {}) {
            if (navigator.vibrate) navigator.vibrate(50);
            conn.send({ type, ...payload });
        }

        function updateName(team, name) {
            conn.send({ type: 'NAME', team, name });
        }

        function disconnect() {
            if (peer) peer.destroy();
            location.reload();
        }

        function showStatus(msg, isError) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = isError ? "text-center mt-3 text-red-500 text-sm font-bold" : "text-center mt-3 text-slate-500 text-sm";
        }

        function resetBtn() {
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('connectBtn').textContent = "CONNECT";
        }
    </script>
</body>

</html>