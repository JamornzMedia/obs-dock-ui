<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBSCam Sender V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            background: #000;
            color: white;
            touch-action: manipulation;
            font-family: 'Segoe UI', sans-serif;
        }

        /* Force GPU Acceleration for Video */
        .video-full {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: translateZ(0);
            will-change: transform;
        }

        #setup {
            min-height: 100vh;
            height: auto;
        }

        select {
            -webkit-appearance: none;
            appearance: none;
        }

        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        .grid-lines {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
        }

        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .grid-cell:nth-child(-n+3) {
            border-top: none;
        }

        .grid-cell:nth-child(n+7) {
            border-bottom: none;
        }

        .grid-cell:nth-child(3n+1) {
            border-left: none;
        }

        .grid-cell:nth-child(3n) {
            border-right: none;
        }

        .right-bar {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
            padding-right: 10px;
            z-index: 50;
        }

        .ui-rotate-90 {
            transform: rotate(90deg);
            transition: transform 0.3s;
        }
    </style>
</head>

<body>
    <div id="setup"
        class="p-6 py-10 flex flex-col min-h-screen justify-center bg-slate-950 relative z-10 overflow-y-auto">
        <h1 class="text-xl font-bold text-center text-blue-400 uppercase tracking-widest mb-4">OBSCam Sender V2.0</h1>

        <div class="space-y-3 max-w-sm mx-auto w-full">
            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Target Room ID</label>
                <div class="flex gap-2">
                    <input type="tel" id="room-id" placeholder="######" maxlength="6"
                        class="w-full bg-black border border-gray-700 p-3 rounded-lg text-center text-3xl font-mono text-white outline-none">
                    <button onclick="startQRScanner()"
                        class="bg-gray-800 w-16 rounded-lg flex items-center justify-center text-blue-400 hover:bg-gray-700"><i
                            class="fas fa-qrcode text-2xl"></i></button>
                </div>
            </div>

            <div class="bg-blue-900/20 p-3 rounded-xl border border-blue-500/30">
                <label class="text-[10px] text-blue-300 font-bold uppercase block mb-1">Send To (Target)</label>
                <select id="cam-index"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-blue-500/50 outline-none font-bold">
                    <option value="1">CAMERA 1</option>
                    <option value="2">CAMERA 2</option>
                    <option value="3">CAMERA 3</option>
                    <option value="4">CAMERA 4</option>
                </select>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Initial Camera</label>
                <select id="camera-select"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-gray-700 outline-none">
                    <option value="">Default (Rear/Auto)</option>
                </select>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Res / FPS</label>
                <div class="flex gap-2">
                    <select id="res" class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                        <option value="1080">1080p</option>
                        <option value="720" selected>720p</option>
                        <option value="480">480p</option>
                    </select>
                    <select id="fps" class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                        <option value="24">24 FPS</option>
                        <option value="30" selected>30 FPS</option>
                        <option value="60">60 FPS</option>
                    </select>
                </div>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Bitrate (Mbps)</label>
                <select id="bitrate"
                    class="w-full h-full bg-black text-white p-3 rounded-lg text-sm border border-gray-700 outline-none"
                    onchange="checkCustomBitrate(this)">
                    <option value="2500">2.5 M</option>
                    <option value="3500">3.5 M</option>
                    <option value="4000">4.0 M</option>
                    <option value="6000">6.0 M</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>

            <button onclick="startStreaming()"
                class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg shadow-lg mt-2 active:scale-95 transition-transform text-white">START
                STREAMING</button>
        </div>
        <div class="text-center mt-6 pt-4 pb-4">
            <p class="text-[10px] text-gray-500">Developed by <span class="text-blue-400 font-bold">JamornzMedia</span>
            </p>
            <p class="text-[9px] text-gray-600">OBSCam V2.0</p>
        </div>
    </div>

    <div id="qr-overlay" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"><video
            id="qr-video" class="absolute inset-0 w-full h-full object-cover"></video>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-64 h-64 border-2 border-blue-500 rounded-lg relative"></div>
        </div><button onclick="stopQRScanner()"
            class="absolute bottom-10 bg-red-600 px-8 py-3 rounded-full font-bold shadow-lg z-20 text-white">CANCEL</button><canvas
            id="qr-canvas" hidden></canvas>
    </div>

    <div id="live-ui" class="hidden absolute inset-0 bg-black z-0 transition-transform duration-300">
        <video id="preview" class="video-full" autoplay playsinline muted></video>
        <div id="grid-layer" class="grid-lines hidden">
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
            <div class="grid-cell"></div>
        </div>

        <div id="overlay-controls" class="absolute inset-0 pointer-events-none transition-opacity duration-300">
            <div class="absolute top-4 left-4 flex flex-col gap-2 pointer-events-auto">
                <div class="bg-black/50 px-3 py-1 rounded-full border border-white/10 w-fit">
                    <span id="status-txt" class="text-xs text-yellow-400 font-bold">Connecting...</span>
                    <div id="realtime-bw" class="text-[10px] text-green-400 font-mono mt-[-2px] font-bold">0 kbps</div>
                    <div id="live-room-display" class="text-[8px] text-gray-500 font-mono">Room: -----</div>
                </div>

                <select id="live-bitrate" onchange="updateLiveBitrate(this)"
                    class="bg-black/50 text-white text-[10px] px-2 py-1 rounded border border-white/20 outline-none w-24">
                    <option value="2500">2.5M</option>
                    <option value="3500">3.5M</option>
                    <option value="4000">4.0M</option>
                    <option value="6000">6.0M</option>
                    <option value="custom">Custom...</option>
                </select>
            </div>

            <div class="absolute bottom-6 left-6 flex gap-2 pointer-events-auto items-center">
                <button onclick="stopStreaming()"
                    class="bg-red-600/80 w-10 h-10 rounded-full flex items-center justify-center shadow active:scale-90 transition-transform text-white"><i
                        class="fas fa-stop"></i></button>
                <button onclick="reconnectSignaling()"
                    class="bg-yellow-500/80 w-8 h-8 rounded-full flex items-center justify-center shadow active:scale-90 transition-transform text-white"
                    title="Reconnect Signal"><i class="fas fa-sync text-xs"></i></button>
                <select id="live-cam-select" onchange="switchCamera(this.value)"
                    class="bg-black/50 text-white text-[10px] h-10 px-2 rounded-full border border-white/20 outline-none max-w-[80px] truncate">
                    <option value="">Switch Cam...</option>
                </select>
            </div>

            <div class="right-bar">
                <button onclick="rotateUI()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-blue-500"><i
                        class="fas fa-redo text-white"></i></button>
                <button onclick="toggleTorch()" id="torch-btn"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-yellow-500"><i
                        class="fas fa-bolt text-white"></i></button>
                <button onclick="triggerAutoFocus()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-blue-500"><i
                        class="fas fa-crosshairs text-white"></i></button>
                <button onclick="toggleGrid()" id="grid-btn"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-purple-500"><i
                        class="fas fa-border-all text-white"></i></button>
                <button onclick="toggleFullScreen()"
                    class="w-10 h-10 rounded-full bg-black/40 border border-white/30 backdrop-blur flex items-center justify-center active:bg-green-500"><i
                        class="fas fa-expand text-white"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRpQWN6J1HYE4r5R8YC2od0ZBt_gSm-iQ",
            authDomain: "obscam-p2p.firebaseapp.com",
            databaseURL: "https://obscam-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obscam-p2p",
            storageBucket: "obscam-p2p.firebasestorage.app",
            messagingSenderId: "531335072084",
            appId: "1:531335072084:web:dc373db6b66581a63160c1"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        let pcs = { monitor: null, obs: null };
        let myStream, videoTrack, qrStream, customBitrateVal = 2500, targetCamIndex = "1";
        let isUIRotated = false, statsInterval = null;
        let lastBytes = 0, lastTime = 0;

        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');

        initCameraSelection().then(() => { loadSettings(); });

        async function initCameraSelection() {
            try {
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoSelect = document.getElementById('camera-select');
                const liveSelect = document.getElementById('live-cam-select');
                videoSelect.innerHTML = '<option value="">Default (Rear/Auto)</option>';
                liveSelect.innerHTML = '<option value="">Switch Cam...</option>';
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const option = new Option(device.label || `Camera`, device.deviceId);
                        videoSelect.appendChild(option);
                        liveSelect.appendChild(option.cloneNode(true));
                    }
                });
            } catch (e) { console.log("Permission Error"); }
        }

        function loadSettings() {
            if (roomFromUrl) { document.getElementById('room-id').value = roomFromUrl; }
            else if (localStorage.getItem('obs_room_id')) { document.getElementById('room-id').value = localStorage.getItem('obs_room_id'); }

            if (localStorage.getItem('obs_cam_index')) document.getElementById('cam-index').value = localStorage.getItem('obs_cam_index');

            // Bitrate Load
            if (localStorage.getItem('obs_bitrate')) {
                const b = localStorage.getItem('obs_bitrate');
                const sel = document.getElementById('bitrate');
                if (b === 'custom' && localStorage.getItem('obs_custom_bitrate')) {
                    customBitrateVal = parseInt(localStorage.getItem('obs_custom_bitrate'));
                    sel.options[sel.options.length - 1].text = `Custom (${customBitrateVal})`;
                    sel.value = 'custom';
                } else { sel.value = b; }
            }
        }

        function saveSettings() {
            localStorage.setItem('obs_room_id', document.getElementById('room-id').value);
            localStorage.setItem('obs_cam_index', document.getElementById('cam-index').value);
            localStorage.setItem('obs_bitrate', document.getElementById('bitrate').value);
            if (document.getElementById('bitrate').value === 'custom') localStorage.setItem('obs_custom_bitrate', customBitrateVal);
        }

        function checkCustomBitrate(el) {
            if (el.value === 'custom') {
                const val = prompt("กรอก Bitrate (kbps):", customBitrateVal);
                if (val && !isNaN(val)) {
                    customBitrateVal = parseInt(val);
                    el.options[el.options.length - 1].text = `Custom (${val})`;
                } else { el.value = "2500"; }
            }
        }

        function updateLiveBitrate(el) {
            let val = el.value;
            if (val === 'custom') {
                const input = prompt("Live Bitrate (kbps):", customBitrateVal);
                if (input && !isNaN(input)) { val = parseInt(input); customBitrateVal = val; el.options[el.options.length - 1].text = `Custom (${val})`; }
                else { el.value = "2500"; return; }
            }
            // Update ทั้ง 2 ท่อ
            if (pcs.monitor) setBitrate(pcs.monitor, parseInt(val) * 1000);
            if (pcs.obs) setBitrate(pcs.obs, parseInt(val) * 1000);
        }

        async function startStreaming() {
            saveSettings();
            const rid = document.getElementById('room-id').value;
            if (rid.length < 6) return alert('Room ID ต้องมี 6 หลัก');

            document.getElementById('live-room-display').innerText = "Room: " + rid;
            document.getElementById('status-txt').innerText = "Checking...";

            const roomSnap = await db.ref(`rooms/${rid}/active`).get();
            if (!roomSnap.exists()) {
                alert(`ไม่พบห้อง ${rid}!\nโปรดเปิดหน้าจอคอมพิวเตอร์ (Monitor) ให้ขึ้นเลขห้องก่อนครับ`);
                return;
            }

            targetCamIndex = document.getElementById('cam-index').value;
            const quality = parseInt(document.getElementById('res').value);
            const fpsVal = parseInt(document.getElementById('fps').value);
            const selectedCamId = document.getElementById('camera-select').value;

            let videoConstraints = { width: { ideal: quality * 1.777 }, height: { ideal: quality }, frameRate: { ideal: fpsVal } };
            if (selectedCamId) videoConstraints.deviceId = { exact: selectedCamId }; else videoConstraints.facingMode = 'environment';

            try {
                try { myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoConstraints }); }
                catch (err) { delete videoConstraints.facingMode; delete videoConstraints.deviceId; myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoConstraints }); }

                videoTrack = myStream.getVideoTracks()[0];
                document.getElementById('preview').srcObject = myStream;
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('live-ui').classList.remove('hidden');

                db.ref(`rooms/${rid}/cam${targetCamIndex}`).onDisconnect().remove();

                // Connect Dual Stream
                connectToPath(rid, targetCamIndex, 'monitor');
                connectToPath(rid, targetCamIndex, 'obs');

                // Start Real Stats Reporting
                startUpdatingStats(rid, targetCamIndex);

            } catch (e) { alert('Camera Error: ' + e.message); }
        }

        function stopStreaming() {
            if (myStream) myStream.getTracks().forEach(track => track.stop());
            if (pcs.monitor) pcs.monitor.close();
            if (pcs.obs) pcs.obs.close();
            pcs = { monitor: null, obs: null };
            clearInterval(statsInterval);

            const rid = document.getElementById('room-id').value;
            if (rid && targetCamIndex) {
                db.ref(`rooms/${rid}/cam${targetCamIndex}`).remove();
                db.ref(`rooms/${rid}/cam${targetCamIndex}`).onDisconnect().cancel();
            }

            document.getElementById('live-ui').classList.add('hidden');
            document.getElementById('setup').classList.remove('hidden');
        }

        function reconnectSignaling() {
            const rid = document.getElementById('room-id').value;
            if (rid && targetCamIndex) {
                if (pcs.monitor) pcs.monitor.close();
                if (pcs.obs) pcs.obs.close();
                connectToPath(rid, targetCamIndex, 'monitor');
                connectToPath(rid, targetCamIndex, 'obs');
            }
        }

        async function switchCamera(deviceId) {
            if (!deviceId || !myStream) return;
            try {
                myStream.getVideoTracks().forEach(t => t.stop());
                const quality = parseInt(document.getElementById('res').value);
                const fpsVal = parseInt(document.getElementById('fps').value);
                const newStream = await navigator.mediaDevices.getUserMedia({
                    audio: false,
                    video: { deviceId: { exact: deviceId }, width: { ideal: quality * 1.777 }, height: { ideal: quality }, frameRate: { ideal: fpsVal } }
                });
                const newVideoTrack = newStream.getVideoTracks()[0];

                ['monitor', 'obs'].forEach(key => {
                    if (pcs[key]) {
                        const sender = pcs[key].getSenders().find(s => s.track.kind === 'video');
                        if (sender) sender.replaceTrack(newVideoTrack);
                    }
                });

                const audioTrack = myStream.getAudioTracks()[0];
                myStream = new MediaStream([audioTrack, newVideoTrack]);
                document.getElementById('preview').srcObject = myStream;
                videoTrack = newVideoTrack;
                document.getElementById('live-cam-select').value = "";
            } catch (e) { alert("Switch failed: " + e.message); }
        }

        async function connectToPath(rid, cIdx, type) {
            const statusTxt = document.getElementById('status-txt');
            const roomRef = db.ref(`rooms/${rid}/cam${cIdx}/${type}`);

            const pc = new RTCPeerConnection(rtcConfig);
            pcs[type] = pc;

            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

            pc.onicecandidate = event => { if (event.candidate) roomRef.child('callerCandidates').push(event.candidate.toJSON()); };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await roomRef.child('offer').set({ sdp: offer.sdp, type: offer.type });

            if (type === 'monitor') statusTxt.innerText = "Wait Monitor...";

            roomRef.child('answer').on('value', async snapshot => {
                const data = snapshot.val();
                if (!data) return;
                if (!pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data));
                    if (type === 'monitor') {
                        statusTxt.innerText = `LIVE`;
                        statusTxt.className = "text-xs text-green-400 font-bold";
                    }
                }
            });

            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'disconnected') {
                    if (type === 'monitor') {
                        statusTxt.innerText = "Disconnect";
                        statusTxt.className = "text-xs text-red-500 font-bold";
                    }
                }
            };

            roomRef.child('calleeCandidates').on('child_added', snapshot => {
                const candidate = snapshot.val();
                if (candidate) pc.addIceCandidate(new RTCIceCandidate(candidate));
            });

            // Set Bitrate Correctly
            let bitrateVal = document.getElementById('bitrate').value;
            // ** แก้บัค: ถ้าเลือก Preset ค่าต้องมา ถ้า Custom ตัวแปรต้องมา **
            if (bitrateVal === 'custom') bitrateVal = customBitrateVal;
            else bitrateVal = parseInt(bitrateVal);

            setBitrate(pc, bitrateVal * 1000);

            // Sync Live Dropdown
            const liveDrop = document.getElementById('live-bitrate');
            if ([...liveDrop.options].some(o => o.value == bitrateVal)) {
                liveDrop.value = bitrateVal;
            } else {
                const customOpt = liveDrop.querySelector('option[value="custom"]');
                customOpt.text = `Custom (${bitrateVal})`;
                liveDrop.value = "custom";
                customBitrateVal = bitrateVal;
            }
        }

        function setBitrate(pc, bitrate) {
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender) {
                const params = sender.getParameters();
                if (!params.encodings) params.encodings = [{}];
                params.encodings[0].maxBitrate = bitrate;
                sender.setParameters(params).catch(e => console.log(e));
            }
        }

        // --- REAL BITRATE CALCULATION ---
        function startUpdatingStats(rid, cIdx) {
            lastBytes = 0;
            lastTime = Date.now();

            statsInterval = setInterval(async () => {
                let totalBytesSent = 0;
                let activePCs = 0;

                // Loop ทั้ง 2 ท่อ (Monitor + OBS) เพื่อหา Total Upload
                for (let key of ['monitor', 'obs']) {
                    const pc = pcs[key];
                    if (pc && pc.connectionState === 'connected') {
                        activePCs++;
                        const stats = await pc.getStats();
                        stats.forEach(report => {
                            if (report.type === 'outbound-rtp' && report.kind === 'video') {
                                totalBytesSent += report.bytesSent;
                            }
                        });
                    }
                }

                const now = Date.now();
                let currentBitrate = 0;

                if (totalBytesSent > 0 && lastBytes > 0) {
                    // สูตร: (Diff Bytes * 8) / (Diff Time in Seconds) / 1000 = kbps
                    const diffBytes = totalBytesSent - lastBytes;
                    const diffTime = now - lastTime;
                    if (diffTime > 0) {
                        currentBitrate = Math.round((diffBytes * 8) / diffTime); // kbps
                    }
                }

                lastBytes = totalBytesSent;
                lastTime = now;

                // Update UI ฝั่งมือถือ
                document.getElementById('realtime-bw').innerText = `${currentBitrate} kbps`;

                // Update Firebase (ส่งค่า Upload จริงไป)
                let w = 0, h = 0;
                if (videoTrack && videoTrack.getSettings) {
                    w = videoTrack.getSettings().width || 0;
                    h = videoTrack.getSettings().height || 0;
                }

                db.ref(`rooms/${rid}/cam${cIdx}/stats`).set({
                    online: true,
                    realtimeBitrate: currentBitrate, // ค่านี้แหละที่ Control จะดึงไปโชว์
                    res: `${w}x${h}`,
                    ts: Date.now()
                });

            }, 1000); // อัปเดตทุก 1 วินาที
        }

        // --- Utils ---
        function rotateUI() {
            isUIRotated = !isUIRotated;
            const ui = document.getElementById('overlay-controls');
            if (isUIRotated) {
                ui.classList.add('ui-rotate-90');
                ui.style.width = "100vh"; ui.style.height = "100vw"; ui.style.top = "50%"; ui.style.left = "50%"; ui.style.translate = "-50% -50%";
            } else {
                ui.classList.remove('ui-rotate-90');
                ui.style.width = "100%"; ui.style.height = "100%"; ui.style.top = "0"; ui.style.left = "0"; ui.style.translate = "0 0";
            }
        }
        async function toggleTorch() { if (!videoTrack) return; try { const c = videoTrack.getSettings().torch || false; await videoTrack.applyConstraints({ advanced: [{ torch: !c }] }); document.getElementById('torch-btn').classList.toggle('bg-yellow-500'); } catch (e) { } }
        async function triggerAutoFocus() { if (!videoTrack) return; try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); } catch (e) { } }
        function toggleGrid() { document.getElementById('grid-layer').classList.toggle('hidden'); }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e => { }); else if (document.exitFullscreen) document.exitFullscreen(); }
        async function startQRScanner() {
            document.getElementById('qr-overlay').classList.remove('hidden');
            const video = document.getElementById('qr-video'); const canvas = document.getElementById('qr-canvas'); const ctx = canvas.getContext('2d');
            qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = qrStream; video.play(); requestAnimationFrame(tick);
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code && code.data.length >= 6) { document.getElementById('room-id').value = code.data.replace(/\D/g, '').substring(0, 6); stopQRScanner(); }
                }
                if (!document.getElementById('qr-overlay').classList.contains('hidden')) requestAnimationFrame(tick);
            }
        }
        function stopQRScanner() { document.getElementById('qr-overlay').classList.add('hidden'); if (qrStream) qrStream.getTracks().forEach(t => t.stop()); }
    </script>
</body>

</html>