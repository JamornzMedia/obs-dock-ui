<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBSCam Phone V1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body {
            background: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
            font-family: 'Segoe UI', sans-serif;
        }

        .video-full {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        select {
            -webkit-appearance: none;
            appearance: none;
        }

        /* ซ่อน Scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
    </style>
</head>

<body>
    <div id="setup" class="p-6 flex flex-col h-screen justify-center bg-slate-950 relative z-10 overflow-y-auto">
        <h1 class="text-xl font-bold text-center text-blue-400 uppercase tracking-widest mb-4">OBSCam Sender V1.1</h1>

        <div class="space-y-3 max-w-sm mx-auto w-full">
            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Target Room ID</label>
                <div class="flex gap-2">
                    <input type="tel" id="room-id" placeholder="######" maxlength="6"
                        class="w-full bg-black border border-gray-700 p-3 rounded-lg text-center text-3xl font-mono text-white outline-none">
                    <button onclick="startQRScanner()"
                        class="bg-gray-800 w-16 rounded-lg flex items-center justify-center text-blue-400 hover:bg-gray-700"><i
                            class="fas fa-qrcode text-2xl"></i></button>
                </div>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Select Camera</label>
                <select id="camera-select"
                    class="w-full bg-black text-white p-3 rounded-lg text-sm border border-gray-700 outline-none">
                    <option value="">Default (Rear/Auto)</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Res / FPS</label>
                    <div class="flex flex-col gap-2">
                        <select id="res"
                            class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                            <option value="1080">1080p</option>
                            <option value="720" selected>720p</option>
                            <option value="480">480p</option>
                        </select>
                        <select id="fps"
                            class="w-full bg-black text-white p-2 rounded-lg text-xs border border-gray-700">
                            <option value="30" selected>30 FPS</option>
                            <option value="60">60 FPS</option>
                        </select>
                    </div>
                </div>
                <div class="bg-gray-900 p-3 rounded-xl border border-gray-800">
                    <label class="text-[10px] text-gray-500 font-bold uppercase block mb-1">Bitrate (Mbps)</label>
                    <select id="bitrate"
                        class="w-full h-full bg-black text-white p-2 rounded-lg text-sm border border-gray-700 outline-none"
                        onchange="checkCustomBitrate(this)">
                        <option value="2500">2.5 M (Std)</option>
                        <option value="3000">3.0 M</option>
                        <option value="3500">3.5 M</option>
                        <option value="4000">4.0 M (High)</option>
                        <option value="6000">6.0 M</option>
                        <option value="custom">Custom...</option>
                    </select>
                </div>
            </div>

            <button onclick="startStreaming()"
                class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold text-lg shadow-lg mt-2 active:scale-95 transition-transform text-white">START
                STREAMING</button>
        </div>

        <div class="text-center mt-6 pt-4">
            <p class="text-[10px] text-gray-500">Developed by <span class="text-blue-400 font-bold">JamornzMedia</span>
            </p>
            <p class="text-[9px] text-gray-600">OBSCam V1.1</p>
        </div>
    </div>

    <div id="qr-overlay" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center"><video
            id="qr-video" class="absolute inset-0 w-full h-full object-cover"></video>
        <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <div class="w-64 h-64 border-2 border-blue-500 rounded-lg relative"></div>
        </div><button onclick="stopQRScanner()"
            class="absolute bottom-10 bg-red-600 px-8 py-3 rounded-full font-bold shadow-lg z-20 text-white">CANCEL</button><canvas
            id="qr-canvas" hidden></canvas>
    </div>

    <div id="live-ui" class="hidden absolute inset-0 bg-black z-0">
        <video id="preview" class="video-full" autoplay playsinline muted></video>
        <div id="overlay-controls" class="absolute inset-0 pointer-events-none">
            <div class="absolute top-4 left-4 bg-black/50 px-3 py-1 rounded-full"><span id="status-txt"
                    class="text-xs text-yellow-400">Connecting...</span></div>
            <button onclick="location.reload()"
                class="absolute bottom-6 left-6 bg-red-600 w-12 h-12 rounded-full flex items-center justify-center shadow pointer-events-auto text-white"><i
                    class="fas fa-stop"></i></button>
        </div>
    </div>

    <script>
        // --- CONFIG ของคุณ ---
        const firebaseConfig = {
            apiKey: "AIzaSyCRpQWN6J1HYE4r5R8YC2od0ZBt_gSm-iQ",
            authDomain: "obscam-p2p.firebaseapp.com",
            databaseURL: "https://obscam-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "obscam-p2p",
            storageBucket: "obscam-p2p.firebasestorage.app",
            messagingSenderId: "531335072084",
            appId: "1:531335072084:web:dc373db6b66581a63160c1"
        };
        // -------------------

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        let pc, myStream, videoTrack, qrStream, customBitrateVal = 2500;

        // Init
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        if (roomFromUrl) document.getElementById('room-id').value = roomFromUrl;

        // ขอ Permission และโหลดรายชื่อกล้อง
        initCameraSelection();

        async function initCameraSelection() {
            try {
                // ขออนุญาตใช้กล้องครั้งแรกเพื่อดึงชื่ออุปกรณ์
                await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoSelect = document.getElementById('camera-select');

                // ล้าง option เก่า (เหลือ default)
                videoSelect.innerHTML = '<option value="">Default (Rear/Auto)</option>';

                let count = 1;
                devices.forEach(device => {
                    if (device.kind === 'videoinput') {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.text = device.label || `Camera ${count++}`;
                        videoSelect.appendChild(option);
                    }
                });
            } catch (e) {
                console.log("Permission not granted yet or no camera found");
            }
        }

        function checkCustomBitrate(el) {
            if (el.value === 'custom') {
                const val = prompt("กรอก Bitrate (kbps) เช่น 3000:", customBitrateVal);
                if (val && !isNaN(val)) {
                    customBitrateVal = parseInt(val);
                    // สร้าง option ชั่วคราวมาแสดง
                    el.options[el.options.length - 1].text = `Custom (${val})`;
                } else {
                    el.value = "2500"; // กลับไปค่าเดิม
                }
            }
        }

        async function startStreaming() {
            const rid = document.getElementById('room-id').value;
            if (rid.length < 6) return alert('Room ID ต้องมี 6 หลัก');

            const quality = parseInt(document.getElementById('res').value);
            const fpsVal = parseInt(document.getElementById('fps').value);
            const selectedCamId = document.getElementById('camera-select').value;

            // ตั้งค่ากล้อง
            let videoConstraints = {
                width: { ideal: quality * 1.777 },
                height: { ideal: quality },
                frameRate: { ideal: fpsVal }
            };

            // ถ้าเลือกกล้องเจาะจง ให้ใช้ deviceId ถ้าไม่เลือก ให้ลองใช้ environment (กล้องหลัง)
            if (selectedCamId) {
                videoConstraints.deviceId = { exact: selectedCamId };
            } else {
                videoConstraints.facingMode = 'environment';
            }

            try {
                try {
                    // รอบแรก: ลองเปิดตามที่ขอ
                    myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoConstraints });
                } catch (err) {
                    console.warn("First attempt failed, trying fallback...", err);
                    // รอบสอง: ถ้าเปิดไม่ได้ (เช่น environment ในคอม) ให้เปิดแบบไม่ระบุสเปค
                    delete videoConstraints.facingMode;
                    delete videoConstraints.deviceId;
                    myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoConstraints });
                }

                document.getElementById('preview').srcObject = myStream;
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('live-ui').classList.remove('hidden');

                connectToRoom(rid);
            } catch (e) {
                alert('Camera Error: ' + e.message + '\n(เช็คว่ามีแอปอื่นใช้กล้องอยู่ไหม)');
            }
        }

        async function connectToRoom(rid) {
            const roomRef = db.ref(`rooms/${rid}`);
            pc = new RTCPeerConnection(rtcConfig);
            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

            pc.onicecandidate = event => { if (event.candidate) roomRef.child('callerCandidates').push(event.candidate.toJSON()); };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            await roomRef.child('offer').set({ sdp: offer.sdp, type: offer.type });

            roomRef.child('answer').on('value', async snapshot => {
                const data = snapshot.val();
                if (!data) return;

                if (!pc.currentRemoteDescription) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data));
                    document.getElementById('status-txt').innerText = "CONNECTED (LIVE)";
                    document.getElementById('status-txt').className = "text-xs text-green-400 font-bold";
                }
            });

            roomRef.child('calleeCandidates').on('child_added', snapshot => { const candidate = snapshot.val(); if (candidate) pc.addIceCandidate(new RTCIceCandidate(candidate)); });

            // คำนวณ Bitrate
            let bitrateVal = document.getElementById('bitrate').value;
            if (bitrateVal === 'custom') bitrateVal = customBitrateVal;
            else bitrateVal = parseInt(bitrateVal);

            // แปลงเป็น bps (x1000)
            setBitrate(pc, bitrateVal * 1000);
        }

        function setBitrate(pc, bitrate) {
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender) {
                const params = sender.getParameters();
                if (!params.encodings) params.encodings = [{}];
                params.encodings[0].maxBitrate = bitrate;
                sender.setParameters(params).catch(e => console.log(e));
            }
        }

        async function startQRScanner() {
            document.getElementById('qr-overlay').classList.remove('hidden');
            const video = document.getElementById('qr-video');
            const canvas = document.getElementById('qr-canvas');
            const ctx = canvas.getContext('2d');
            qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = qrStream; video.play(); requestAnimationFrame(tick);
            function tick() {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight; canvas.width = video.videoWidth;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const code = jsQR(ctx.getImageData(0, 0, canvas.width, canvas.height).data, canvas.width, canvas.height);
                    if (code && code.data.includes('room=')) { document.getElementById('room-id').value = new URL(code.data).searchParams.get('room'); stopQRScanner(); }
                    else if (code && code.data.length >= 6) { document.getElementById('room-id').value = code.data.replace(/\D/g, '').substring(0, 6); stopQRScanner(); }
                }
                if (!document.getElementById('qr-overlay').classList.contains('hidden')) requestAnimationFrame(tick);
            }
        }
        function stopQRScanner() { document.getElementById('qr-overlay').classList.add('hidden'); if (qrStream) qrStream.getTracks().forEach(t => t.stop()); }
    </script>
</body>

</html>