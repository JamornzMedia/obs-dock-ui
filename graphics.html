<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sticker Animation to GIF Generator v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 2rem;
            padding: 2rem;
            flex-wrap: wrap;
        }
        .preview-area, .controls-area {
            background-color: #2a2a2a;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 550px;
        }
        .preview-area {
            text-align: center;
        }
        h1, h2 {
            margin-top: 0;
            color: #00aaff;
            border-bottom: 1px solid #444;
            padding-bottom: 0.5rem;
        }
        canvas {
            background-color: #111;
            border-radius: 8px;
            border: 1px solid #444;
            transition: width 0.2s, height 0.2s;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .full-width { grid-column: 1 / -1; }
        label { font-size: 0.9rem; font-weight: 500; }
        input, select {
            width: 100%;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #333;
            color: #eee;
        }
        button {
            grid-column: 1 / -1;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            background-color: #0088cc;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover:not(:disabled) { background-color: #00aaff; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        progress { width: 100%; -webkit-appearance: none; appearance: none; }
        progress::-webkit-progress-bar { background-color: #444; border-radius: 4px; }
        progress::-webkit-progress-value { background-color: #00aaff; border-radius: 4px; transition: width 0.1s linear; }
        .value-display { font-weight: bold; color: #00aaff; }
    </style>
</head>
<body>

    <div class="preview-area">
        <h2>ตัวอย่าง Animation</h2>
        <canvas id="canvas" width="350" height="350"></canvas>
    </div>

    <div class="controls-area">
        <h1>Sticker to GIF Generator v2.0</h1>
        <div class="controls-grid">
            <div class="control-group full-width"><label>1. อัปโหลดไฟล์ PNG:</label><input type="file" id="stickerImageFile" accept="image/png" /></div>
            
            <div class="control-group"><label>ความละเอียด (Resolution): <span id="resolutionValue" class="value-display">350px</span></label><input type="range" min="200" max="500" step="50" value="350" id="resolutionRange" /></div>
            <div class="control-group"><label>ความยาว (Duration): <span id="durationValue" class="value-display">3s</span></label><input type="range" min="1" max="10" step="1" value="3" id="durationRange" /></div>

            <div class="control-group"><label>สไตล์การเด้ง (Bounce Style):</label><select id="bounceStyle"><option value="classic">Classic</option><option value="pulse">Pulse</option><option value="elastic">Elastic</option></select></div>
            <div class="control-group"><label>Scale Amount: <input type="range" min="1" max="1.3" step="0.01" value="1.1" id="scaleRange" /></label></div>
            <div class="control-group"><label>Bounce Speed: <input type="range" min="0.1" max="3" step="0.1" value="1" id="speedRange" /></label></div>
            <div class="control-group"><label>Rotate Degrees: <input type="range" min="-20" max="20" step="1" value="5" id="rotateRange" /></label></div>
            <div class="control-group"><label>Glow Color: <input type="color" id="glowColor" value="#00ffff" /></label></div>
            <div class="control-group"><label>Glow Size: <input type="range" min="0" max="30" step="1" value="15" id="glowSize" /></label></div>
            
            <button id="generateBtn" disabled>2. สร้างไฟล์ GIF</button>
            <div class="full-width">
                <progress id="progressBar" value="0" max="100"></progress>
                <p id="status" style="text-align: center; min-height: 20px;"></p>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const generateBtn = document.getElementById('generateBtn');
        const statusText = document.getElementById('status');
        const progressBar = document.getElementById('progressBar');

        const controls = {
            imageInput: document.getElementById('stickerImageFile'),
            resolutionRange: document.getElementById('resolutionRange'),
            resolutionValue: document.getElementById('resolutionValue'),
            durationRange: document.getElementById('durationRange'),
            durationValue: document.getElementById('durationValue'),
            bounceStyle: document.getElementById('bounceStyle'),
            scaleRange: document.getElementById('scaleRange'),
            speedRange: document.getElementById('speedRange'),
            rotateRange: document.getElementById('rotateRange'),
            glowColor: document.getElementById('glowColor'),
            glowSize: document.getElementById('glowSize'),
        };

        let stickerImage = null;
        let previewAnimationId = null;

        // --- อัปเดต UI แสดงค่า ---
        controls.resolutionRange.addEventListener('input', (e) => {
            const size = e.target.value;
            controls.resolutionValue.textContent = `${size}px`;
            canvas.width = size;
            canvas.height = size;
        });
        controls.durationRange.addEventListener('input', (e) => {
            controls.durationValue.textContent = `${e.target.value}s`;
        });
        
        // --- โหลดรูปภาพ ---
        controls.imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                stickerImage = new Image();
                stickerImage.onload = () => {
                    generateBtn.disabled = false;
                    startPreview();
                };
                stickerImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // --- ฟังก์ชันคำนวณ Animation Styles ---
        const animationFunctions = {
            classic: (time, speed, scaleMax) => {
                return 1 + (Math.sin(time / (speed * 500)) * (scaleMax - 1));
            },
            pulse: (time, speed, scaleMax) => {
                const cycleDuration = 1000 * speed;
                const t = time % cycleDuration;
                if (t < cycleDuration / 2) {
                    // Ease-out cubic function for the bounce
                    const x = t / (cycleDuration / 2);
                    return 1 + ((1 - Math.pow(1 - x, 3)) * (scaleMax - 1));
                }
                return 1.0; // Pause
            },
            elastic: (time, speed, scaleMax) => {
                const c4 = (2 * Math.PI) / 3;
                const decay = 10 / (1000 * speed); // Control how fast it stops
                const t = time % (1000 * speed);
                if (t === 0) return 1.0;
                return 1 + ((scaleMax - 1) * Math.pow(2, -10 * t * decay) * Math.sin((t * 10 - 0.75) * c4) + (scaleMax-1));
            }
        };
        
        // --- ฟังก์ชันวาด 1 เฟรม ---
        function drawFrame(time) {
            const width = canvas.width;
            const height = canvas.height;
            
            const scaleMax = parseFloat(controls.scaleRange.value);
            const speed = parseFloat(controls.speedRange.value);
            const rotationMax = parseInt(controls.rotateRange.value) * (Math.PI / 180);
            const rotateSpeed = 2.0; // Fixed for simplicity, can be a control
            const glowColor = controls.glowColor.value;
            const glowSize = parseInt(controls.glowSize.value);
            const bounceStyle = controls.bounceStyle.value;

            const scaleAmount = animationFunctions[bounceStyle](time, speed, scaleMax);
            const rotationAmount = Math.sin(time / (rotateSpeed * 500)) * rotationMax;

            ctx.clearRect(0, 0, width, height);
            ctx.shadowColor = glowColor;
            ctx.shadowBlur = glowSize;
            
            ctx.save();
            ctx.translate(width / 2, height / 2);
            ctx.rotate(rotationAmount);
            ctx.scale(scaleAmount, scaleAmount);
            ctx.drawImage(stickerImage, -stickerImage.width / 2, -stickerImage.height / 2);
            ctx.restore();
            
            ctx.shadowBlur = 0;
        }

        // --- แสดงตัวอย่าง Animation ---
        function startPreview() {
            if (previewAnimationId) cancelAnimationFrame(previewAnimationId);
            const animateLoop = () => {
                if (stickerImage) drawFrame(Date.now());
                previewAnimationId = requestAnimationFrame(animateLoop);
            };
            animateLoop();
        }

        // --- สร้างไฟล์ GIF ---
        generateBtn.addEventListener('click', () => {
            if (!stickerImage) return;

            generateBtn.disabled = true;
            statusText.textContent = 'กำลังเริ่มต้น...';
            progressBar.value = 0;

            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: canvas.width,
                height: canvas.height,
                workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js',
                transparent: 0x000000,
            });

            const duration = parseInt(controls.durationRange.value);
            const fps = 30;
            const frameCount = duration * fps;
            const frameDelay = 1000 / fps;

            // --- Hook a 'progress' event to update the progress bar ---
            gif.on('progress', (p) => {
                const percentage = Math.round(p * 100);
                progressBar.value = percentage;
                statusText.textContent = `กำลังประมวลผล... ${percentage}%`;
            });

            gif.on('finished', (blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sticker.gif';
                a.click();
                URL.revokeObjectURL(url);
                
                generateBtn.disabled = false;
                statusText.textContent = 'สร้างไฟล์ GIF สำเร็จ!';
            });
            
            // Loop to add frames
            for (let i = 0; i < frameCount; i++) {
                const simulatedTime = (i / frameCount) * duration * 1000;
                drawFrame(simulatedTime);
                gif.addFrame(ctx, {copy: true, delay: frameDelay});
            }

            gif.render();
        });
    </script>
</body>
</html>
