<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>OBS VAR Replay V1.1 (Revised) - JamornzMedia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ================= CORE STYLES ================= */
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* --- Screen Mode (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) --- */
        .screen-mode body {
            background: transparent;
        }

        .screen-mode #controls-ui {
            display: none !important;
        }

        .screen-mode #video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: transparent;
        }

        .screen-mode video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform-origin: center center;
            will-change: transform;
        }

        /* --- Control Mode (‡∏£‡∏µ‡πÇ‡∏°‡∏ó) --- */
        .control-mode {
            background: #1e1e1e;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .control-mode #video-wrapper {
            display: none;
        }

        /* Drop Zone */
        #drop-zone {
            border: 2px dashed #555;
            background: #2b2b2b;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            color: #aaa;
            font-size: 12px;
            transition: 0.2s;
            position: relative;
        }

        #drop-zone:hover {
            border-color: #00aaff;
            background: #333;
            color: #fff;
        }

        /* --- Timeline System --- */
        .timeline-wrapper {
            margin-bottom: 10px;
            background: #252525;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        /* 1. Main Detailed Timeline */
        .timeline-container {
            position: relative;
            height: 35px;
            margin-bottom: 5px;
            user-select: none;
            overflow: hidden;
            background: #1a1a1a;
            border-radius: 4px;
        }

        .track-bg {
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            pointer-events: none;
        }

        .track-fill {
            position: absolute;
            top: 15px;
            left: 0;
            height: 6px;
            background: #00aaff;
            border-radius: 3px;
            pointer-events: none;
            width: 0%;
        }

        /* Markers (A/B) on Main Timeline */
        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff3333;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
            pointer-events: none;
            box-shadow: 0 0 5px rgba(255, 50, 50, 0.8);
        }

        .marker-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3333;
            color: #000;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 2px;
            white-space: nowrap;
        }

        /* Invisible Click Layer for Main Timeline */
        .click-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 5;
        }

        /* 2. Navigator (Mini Map) */
        .navigator-container {
            position: relative;
            height: 24px;
            background: #111;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
            user-select: none;
        }

        /* Progress in Nav (Show current playhead globally) */
        .nav-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.5);
            z-index: 1;
            display: none;
        }

        /* The Yellow Window */
        .nav-window {
            position: absolute;
            top: 1px;
            bottom: 1px;
            background: rgba(255, 202, 40, 0.2);
            border: 1px solid #ffca28;
            box-sizing: border-box;
            z-index: 20;
            cursor: grab;
            min-width: 10px;
            /* Minimum zoom size */
        }

        .nav-window:active {
            cursor: grabbing;
            background: rgba(255, 202, 40, 0.3);
        }

        /* Resize Handles */
        .nav-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            background: #ffca28;
            cursor: ew-resize;
            z-index: 30;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-handle::after {
            content: '||';
            font-size: 8px;
            color: #000;
            font-weight: bold;
        }

        .nav-handle.left {
            left: 0;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .nav-handle.right {
            right: 0;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        .nav-handle:hover {
            opacity: 1;
            filter: brightness(1.2);
        }

        .nav-hint {
            font-size: 9px;
            color: #666;
            text-align: center;
            margin-top: 4px;
        }

        /* Buttons & Layout */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            background: #444;
            color: white;
            font-size: 11px;
            transition: 0.2s;
        }

        button:hover {
            filter: brightness(1.2);
        }

        .btn-play {
            background: #2e7d32;
        }

        .btn-pause {
            background: #c62828;
        }

        .active-btn {
            background: #00aaff;
            color: white;
            border: 1px solid #fff;
        }

        /* Sliders */
        .slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 11px;
            color: #aaa;
        }

        .slider-row input {
            flex: 1;
            accent-color: #00aaff;
        }

        /* Joystick Controls */
        .zoom-controls {
            background: #2b2b2b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            border: 1px solid #333;
        }

        .joystick-area {
            display: flex;
            align-items: center;
            justify-content: space-around;
        }

        .joystick-pad {
            width: 100px;
            height: 100px;
            background: #111;
            border-radius: 50%;
            border: 2px solid #444;
            position: relative;
            touch-action: none;
            box-shadow: inset 0 0 10px #000;
        }

        .joystick-stick {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #555, #333);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            border: 1px solid #666;
            box-shadow: 0 4px 5px rgba(0, 0, 0, 0.5);
        }

        .joystick-stick:active {
            background: #00aaff;
        }

        /* Modals */
        .menu-bar {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #333;
            display: flex;
            gap: 5px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
        }

        .btn-outline:hover {
            background: #333;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #252525;
            width: 90%;
            max-width: 350px;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            color: #ddd;
            transform: translateY(20px);
            transition: 0.3s;
            text-align: center;
        }

        .modal-overlay.open .modal {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
        }

        .sponsor-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .sponsor-item {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
        }

        .sponsor-link {
            display: block;
            color: #00aaff;
            text-decoration: none;
            margin-top: 5px;
            font-size: 11px;
        }

        .copy-group {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .copy-input {
            flex: 1;
            background: #111;
            border: 1px solid #444;
            color: #00aaff;
            padding: 8px;
            font-size: 11px;
        }

        #loop-status {
            color: #cc3333;
            font-weight: bold;
            font-size: 11px;
            display: none;
            text-align: center;
            margin-bottom: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>

    <div id="video-wrapper">
        <video id="mainVideo" muted playsinline></video>
    </div>

    <div id="controls-ui">
        <input type="file" id="fileInput" accept="video/*" style="display:none;" onchange="handleFileSelect(this)">

        <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size:20px;">üìÇ</div>
            <b>‡∏Ñ‡∏•‡∏¥‡∏Å</b> ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà<br>
            <span style="font-size:10px; color:#666;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏¥‡∏õ</span>
        </div>

        <div id="loop-status">‚ö° LOOP A-B ACTIVE ‚ö°</div>

        <div class="timeline-wrapper">
            <div class="timeline-container" id="timelineBox">
                <div class="track-bg"></div>
                <div class="track-fill" id="trackFill"></div>

                <div id="markA" class="marker">
                    <div class="marker-head">A</div>
                </div>
                <div id="markB" class="marker">
                    <div class="marker-head">B</div>
                </div>

                <div class="click-layer" onmousedown="userScrubStart(event)"></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:10px; color:#888; margin-top:-5px;">
                <span id="currTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>

            <div class="navigator-container" id="navBox">
                <div class="nav-playhead" id="navPlayhead"></div>
                <div class="nav-window" id="navWindow" style="left:0%; width:100%;">
                    <div class="nav-handle left" onmousedown="startNavResize('left', event)"></div>
                    <div class="nav-handle right" onmousedown="startNavResize('right', event)"></div>
                </div>
            </div>
            <div class="nav-hint">üñ±Ô∏è ‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢ | ‡∏•‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô</div>
        </div>

        <div class="btn-grid">
            <button class="btn-play" onclick="sendCmd('play')">‚ñ∂ PLAY</button>
            <button class="btn-pause" onclick="sendCmd('pause')">‚è∏ PAUSE</button>
            <button id="btnSetA" onclick="sendCmd('setA')">SET A</button>
            <button id="btnSetB" onclick="sendCmd('setB')">SET B</button>
        </div>
        <button onclick="sendCmd('clearLoop')" style="width:100%; background:#422; margin-bottom:10px; color:#ffaaaa;">‚ùå
            CLEAR LOOP</button>

        <div class="slider-row" style="flex-wrap:wrap;">
            <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:2px;">
                <span>SPEED: <span id="speedVal" style="color:#00aaff; font-weight:bold;">1.0x</span></span>
            </div>
            <input type="range" id="speedRange" min="0.01" max="2.0" step="0.01" value="1.0"
                oninput="updateSpeed(this.value)">
        </div>

        <div class="zoom-controls">
            <div style="font-size:11px; color:#00aaff; margin-bottom:5px; font-weight:bold;">üîç ZOOM & POSITION
                (Joystick)</div>

            <div class="joystick-area">
                <div style="width:40%;">
                    <div class="slider-row" style="flex-direction:column; align-items: flex-start;">
                        <span>ZOOM (x1-x10):</span>
                        <input type="range" id="zoomRange" min="1.0" max="10.0" step="0.1" value="1.0"
                            oninput="updateTransform()" style="width:100%">
                        <span id="zoomVal" style="align-self: flex-end;">1.0x</span>
                    </div>
                    <button onclick="resetZoom()" style="width:100%; background:#333; margin-top:5px;">RESET</button>
                </div>

                <div class="joystick-pad" id="joyPad">
                    <div class="joystick-stick" id="joyStick"></div>
                </div>
            </div>
        </div>

        <div class="menu-bar">
            <button class="btn btn-outline" style="flex:1;" onclick="openModal('modal-help')">‚ùì Get Link</button>
            <button class="btn btn-outline" style="flex:1; color:#ffca28; border-color:#ffca28;"
                onclick="openModal('modal-sponsor')">üéÅ Sponsor</button>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay" onclick="closeModal(event, 'modal-help')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal(null, 'modal-help')">&times;</button>
            <h2 style="color:#00aaff;">Graphic Link (Screen)</h2>
            <p style="font-size:12px; color:#ccc;">Copy ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô OBS Browser Source</p>

            <div class="copy-group">
                <input type="text" class="copy-input" id="linkInputScreen"
                    value="https://jamornzmedia.github.io/obs-dock-ui/VAR_Replay_V1.1.html?mode=screen" readonly>
                <button style="background:#005f73; color:white; width:60px;"
                    onclick="copyInput('linkInputScreen')">Copy</button>
            </div>
            <div id="copy-msg" style="font-size:11px; color:#44aa44; opacity:0; transition:0.3s;">Copied!</div>
        </div>
    </div>

    <div id="modal-sponsor" class="modal-overlay" onclick="closeModal(event, 'modal-sponsor')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal(null, 'modal-sponsor')">&times;</button>
            <h2 style="color:#ffca28;">Support Developer</h2>
            <div class="sponsor-grid">
                <div class="sponsor-item">
                    <span style="color:#fff; font-weight:bold;">Thai Bank / PromptPay</span>
                    <a href="https://easydonate.app/Jamornz" target="_blank" class="sponsor-link">üëâ
                        easydonate.app/Jamornz</a>
                </div>
                <div class="sponsor-item" style="background:#002233; border:1px solid #00aaff;">
                    <span style="color:#fff; font-weight:bold;">üè† JamornzMedia Home</span>
                    <a href="https://sites.google.com/view/jamornzmedia" target="_blank" class="sponsor-link"
                        style="font-size:13px; color:#fff;">Visit Website</a>
                </div>
            </div>
            <div style="margin-top:20px; font-size:10px; color:#666;">Developed by <b>JamornzMedia</b> V1.1</div>
        </div>
    </div>

    <script>
        const channel = new BroadcastChannel('jamorn_var_v1_revised');
        const video = document.getElementById('mainVideo');
        const dropZone = document.getElementById('drop-zone');
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        let isScrubbing = false;
        let loopA = null, loopB = null;

        // Init Mode
        if (mode === 'screen') {
            document.body.classList.add('screen-mode');
            initScreen();
        } else {
            document.body.classList.add('control-mode');
            initControl();
        }

        // --- Utils ---
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(e, id) { if (e && e.target !== e.currentTarget) return; document.getElementById(id).classList.remove('open'); }
        function copyInput(id) {
            const el = document.getElementById(id);
            el.select(); el.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(el.value);
            document.getElementById('copy-msg').style.opacity = '1';
            setTimeout(() => document.getElementById('copy-msg').style.opacity = '0', 2000);
        }

        // ==========================================
        // üéÆ CONTROL LOGIC (DOCK)
        // ==========================================

        // --- NAVIGATOR VARIABLES ---
        let viewStart = 0; // 0.0 - 1.0 (0% - 100%)
        let viewWidth = 1; // 1.0 = Full Width
        let globalDuration = 1;

        let joyActive = false;
        let joyX = 0, joyY = 0; // -50 to 50

        function initControl() {
            // Drag Drop
            dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('hover'); };
            dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('hover'); };
            dropZone.ondrop = e => {
                e.preventDefault(); dropZone.classList.remove('hover');
                if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
            };

            // Listen from Screen
            channel.onmessage = e => {
                const msg = e.data;
                if (msg.type === 'status') {
                    globalDuration = msg.durSec;

                    if (!isScrubbing) {
                        updateTimelineVisuals(msg.currSec, msg.posA, msg.posB);
                    }

                    document.getElementById('currTime').innerText = msg.currFmt;
                    document.getElementById('totalTime').innerText = msg.totalFmt;
                    document.getElementById('btnSetA').className = msg.hasA ? 'active-btn' : '';
                    document.getElementById('btnSetB').className = msg.hasB ? 'active-btn' : '';
                    document.getElementById('loop-status').style.display = (msg.hasA && msg.hasB) ? 'block' : 'none';

                    // Update Navigator Playhead (White line in mini map)
                    const navPct = (msg.currSec / msg.durSec) * 100;
                    const navHead = document.getElementById('navPlayhead');
                    navHead.style.display = 'block';
                    navHead.style.left = navPct + '%';
                }
            };

            // Init Joystick
            setupJoystick();
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) loadFile(input.files[0]);
        }

        function loadFile(f) {
            dropZone.innerHTML = `<span style="color:#00aaff">Loading: ${f.name}</span>`;
            const r = new FileReader();
            r.onload = evt => {
                let mime = f.type || 'video/mp4';
                if (f.name.toLowerCase().endsWith('.mkv')) mime = 'video/webm';
                channel.postMessage({ type: 'file', data: evt.target.result, mime: mime });
                dropZone.innerHTML = `<span style="color:#44aa44">Ready: ${f.name}</span>`;
                resetZoomUI();
                // Reset Nav to Full
                viewStart = 0; viewWidth = 1; updateNavUI();
                document.getElementById('speedRange').value = 1.0;
                document.getElementById('speedVal').innerText = "1.0x";
            };
            r.readAsArrayBuffer(f);
        }

        // --- TIMELINE LOGIC ---
        // Convert Time(s) to Timeline UI %
        function timeToUiPct(timeSec) {
            if (globalDuration <= 0) return 0;
            let totalPct = timeSec / globalDuration; // 0.0 - 1.0 globally

            // Map to View Window
            // ViewStart = 0.2, ViewWidth = 0.5 (Ends at 0.7)
            // If time is 0.4 -> (0.4 - 0.2) / 0.5 = 0.4 -> 40% on UI
            if (totalPct < viewStart || totalPct > viewStart + viewWidth) return -10; // Off screen

            return ((totalPct - viewStart) / viewWidth) * 100;
        }

        // Convert UI % to Time(s)
        function uiPctToTime(uiPct) {
            let localRatio = uiPct / 100;
            let globalRatio = viewStart + (localRatio * viewWidth);
            return globalRatio * globalDuration;
        }

        function updateTimelineVisuals(currSec, timeA, timeB) {
            // Main Playhead (Fill)
            let fillPct = timeToUiPct(currSec);
            fillPct = Math.max(0, Math.min(100, fillPct));
            document.getElementById('trackFill').style.width = fillPct + "%";

            // Markers
            setMarker('markA', timeA);
            setMarker('markB', timeB);
        }

        function setMarker(id, timeVal) {
            const el = document.getElementById(id);
            if (timeVal !== null) {
                let pct = timeToUiPct(timeVal);
                if (pct >= 0 && pct <= 100) {
                    el.style.display = 'block';
                    el.style.left = pct + '%';
                } else {
                    el.style.display = 'none'; // Hide if zoomed out/panned away
                }
            } else {
                el.style.display = 'none';
            }
        }

        // --- SCRUBBING ---
        function userScrubStart(e) {
            isScrubbing = true;
            scrubMove(e);
            window.addEventListener('mousemove', scrubMove);
            window.addEventListener('mouseup', scrubEnd);
        }
        function scrubMove(e) {
            const box = document.getElementById('timelineBox').getBoundingClientRect();
            let x = e.clientX - box.left;
            let pct = (x / box.width) * 100;
            pct = Math.max(0, Math.min(100, pct));

            document.getElementById('trackFill').style.width = pct + "%";

            let targetTime = uiPctToTime(pct);
            sendCmd('seek', targetTime);
        }
        function scrubEnd() {
            isScrubbing = false;
            window.removeEventListener('mousemove', scrubMove);
            window.removeEventListener('mouseup', scrubEnd);
        }

        // --- NAVIGATOR LOGIC (Handles) ---
        function updateNavUI() {
            const win = document.getElementById('navWindow');
            win.style.left = (viewStart * 100) + "%";
            win.style.width = (viewWidth * 100) + "%";
        }

        let isNavResizing = false;
        let navAction = null; // 'left', 'right', 'move'
        let navStartX = 0;
        let navStartView = 0;
        let navStartWidth = 0;

        function startNavResize(action, e) {
            e.stopPropagation(); e.preventDefault();
            isNavResizing = true;
            navAction = action;
            navStartX = e.clientX;
            navStartView = viewStart;
            navStartWidth = viewWidth;

            window.addEventListener('mousemove', onNavDrag);
            window.addEventListener('mouseup', endNavDrag);
        }

        // Add move listener to Window body for "Pan"
        document.getElementById('navWindow').addEventListener('mousedown', function (e) {
            if (e.target.classList.contains('nav-handle')) return; // Ignore handles
            startNavResize('move', e);
        });

        function onNavDrag(e) {
            if (!isNavResizing) return;
            const box = document.getElementById('navBox').getBoundingClientRect();
            const deltaPx = e.clientX - navStartX;
            const deltaPct = deltaPx / box.width; // Convert px move to % change

            if (navAction === 'move') {
                let newStart = navStartView + deltaPct;
                // Clamp
                if (newStart < 0) newStart = 0;
                if (newStart + navStartWidth > 1) newStart = 1 - navStartWidth;
                viewStart = newStart;
            }
            else if (navAction === 'left') {
                let newStart = navStartView + deltaPct;
                let newWidth = navStartWidth - deltaPct;

                if (newWidth < 0.05) { // Min width 5%
                    newStart = navStartView + navStartWidth - 0.05;
                    newWidth = 0.05;
                }
                if (newStart < 0) { newStart = 0; newWidth = navStartView + navStartWidth; }

                viewStart = newStart;
                viewWidth = newWidth;
            }
            else if (navAction === 'right') {
                let newWidth = navStartWidth + deltaPct;
                if (newWidth < 0.05) newWidth = 0.05;
                if (viewStart + newWidth > 1) newWidth = 1 - viewStart;
                viewWidth = newWidth;
            }

            updateNavUI();
        }

        function endNavDrag() {
            isNavResizing = false;
            window.removeEventListener('mousemove', onNavDrag);
            window.removeEventListener('mouseup', endNavDrag);
        }

        // --- JOYSTICK & ZOOM ---
        function setupJoystick() {
            const pad = document.getElementById('joyPad');
            const stick = document.getElementById('joyStick');

            pad.addEventListener('mousedown', startJoy);

            function startJoy(e) {
                joyActive = true;
                moveJoy(e);
                window.addEventListener('mousemove', moveJoy);
                window.addEventListener('mouseup', endJoy);
            }

            function moveJoy(e) {
                if (!joyActive) return;
                const rect = pad.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                let dx = e.clientX - centerX;
                let dy = e.clientY - centerY;

                const maxDist = 30;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > maxDist) {
                    const ratio = maxDist / dist;
                    dx *= ratio; dy *= ratio;
                }

                stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

                // Map to -50 to 50
                joyX = (dx / maxDist) * 50;
                joyY = (dy / maxDist) * 50;

                updateTransform();
            }

            function endJoy() {
                joyActive = false;
                window.removeEventListener('mousemove', moveJoy);
                window.removeEventListener('mouseup', endJoy);
                // Keep position visually or reset? Standard pan stays.
            }
        }

        function sendCmd(act, val = null) { channel.postMessage({ type: 'cmd', act, val }); }

        function updateSpeed(val) {
            document.getElementById('speedVal').innerText = val + "x";
            sendCmd('speed', val);
        }

        function updateTransform() {
            const z = document.getElementById('zoomRange').value;
            document.getElementById('zoomVal').innerText = z + "x";
            // Ensure values are numbers
            sendCmd('transform', { z: parseFloat(z), x: joyX, y: joyY });
        }
        function resetZoom() {
            resetZoomUI();
            sendCmd('transform', { z: 1, x: 0, y: 0 });
        }
        function resetZoomUI() {
            document.getElementById('zoomRange').value = 1.0;
            document.getElementById('zoomVal').innerText = "1.0x";
            joyX = 0; joyY = 0;
            document.getElementById('joyStick').style.transform = `translate(-50%, -50%)`;
        }

        // ==========================================
        // üì∫ SCREEN LOGIC (OBS)
        // ==========================================
        function initScreen() {
            video.muted = true;
            channel.onmessage = e => {
                const msg = e.data;
                if (msg.type === 'file') {
                    const blob = new Blob([msg.data], { type: msg.mime });
                    video.src = URL.createObjectURL(blob);
                    loopA = null; loopB = null; resetVideoTransform();
                    video.loop = true;
                    video.playbackRate = 1.0; video.play();
                }
                if (msg.type === 'cmd') {
                    switch (msg.act) {
                        case 'play': video.play(); break;
                        case 'pause': video.pause(); break;
                        case 'speed': video.playbackRate = msg.val; break;
                        case 'seek': video.currentTime = msg.val; break;
                        case 'setA': loopA = video.currentTime; break;
                        case 'setB':
                            loopB = video.currentTime;
                            if (loopB < loopA) { let t = loopA; loopA = loopB; loopB = t; } // Swap if wrong order
                            break;

                        case 'clearLoop': loopA = null; loopB = null; break;
                        case 'transform': applyTransform(msg.val); break;
                    }
                }
            };

            video.ontimeupdate = () => {
                if (!video.duration) return;

                // LOOP LOGIC
                if (loopA !== null && loopB !== null) {
                    if (video.currentTime >= loopB || video.currentTime < loopA) {
                        video.currentTime = loopA;
                        if (video.paused) video.play();
                    }
                }

                channel.postMessage({
                    type: 'status',
                    durSec: video.duration,
                    currSec: video.currentTime,
                    currFmt: fmt(video.currentTime),
                    totalFmt: fmt(video.duration),
                    hasA: loopA !== null,
                    hasB: loopB !== null,
                    posA: loopA,
                    posB: loopB
                });
            };
        }

        function applyTransform(t) {
            // Translate first, then Scale. Using percentages relative to frame.
            // Note: X/Y from joystick are -50 to 50. 
            // In CSS translate: Positive X moves Element Right. Positive Y moves Element Down.
            video.style.transform = `scale(${t.z}) translate(${t.x}%, ${t.y}%)`;
        }
        function resetVideoTransform() { video.style.transform = `scale(1) translate(0%, 0%)`; }
        function fmt(s) { let m = Math.floor(s / 60), sc = Math.floor(s % 60); return m + ":" + (sc < 10 ? "0" : "") + sc; }

    </script>
</body>

</html>