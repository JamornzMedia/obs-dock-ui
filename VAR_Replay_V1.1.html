<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <title>OBS VAR Replay V1.1 - JamornzMedia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* ================= CORE STYLES ================= */
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* LOGO STYLE */
        .app-header {
            padding: 10px 10px 5px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #151515;
            border-bottom: 1px solid #333;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 1px;
            color: #fff;
            user-select: none;
        }

        .logo-text span {
            color: #ffca28;
        }

        /* VAR color */

        /* --- Screen Mode (‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) --- */
        .screen-mode body {
            background: transparent;
        }

        .screen-mode #controls-ui {
            display: none !important;
        }

        .screen-mode .app-header {
            display: none !important;
        }

        .screen-mode #video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: transparent;
        }

        .screen-mode video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            /* GPU Acceleration Hints */
            will-change: transform;
            transform: translateZ(0);
            transform-origin: center center;
        }

        /* --- Control Mode (‡∏£‡∏µ‡πÇ‡∏°‡∏ó) --- */
        .control-mode {
            background: #1e1e1e;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .control-mode #video-wrapper {
            display: none;
        }

        .control-mode .app-header {
            margin: -10px -10px 10px -10px;
        }

        /* Drop Zone */
        #drop-zone {
            border: 2px dashed #555;
            background: #2b2b2b;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            color: #aaa;
            font-size: 12px;
            transition: 0.2s;
            position: relative;
        }

        #drop-zone:hover {
            border-color: #00aaff;
            background: #333;
            color: #fff;
        }

        /* --- Timeline System --- */
        .timeline-wrapper {
            margin-bottom: 10px;
            background: #252525;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #333;
        }

        .timeline-container {
            position: relative;
            height: 35px;
            margin-bottom: 5px;
            user-select: none;
            overflow: hidden;
            background: #1a1a1a;
            border-radius: 4px;
        }

        .track-bg {
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            pointer-events: none;
        }

        .track-fill {
            position: absolute;
            top: 15px;
            left: 0;
            height: 6px;
            background: #00aaff;
            border-radius: 3px;
            pointer-events: none;
            width: 0%;
        }

        .marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ff3333;
            transform: translateX(-50%);
            z-index: 10;
            display: none;
            pointer-events: none;
            box-shadow: 0 0 5px rgba(255, 50, 50, 0.8);
        }

        .marker-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3333;
            color: #000;
            font-size: 9px;
            font-weight: bold;
            padding: 2px 4px;
            border-radius: 2px;
            white-space: nowrap;
        }

        .click-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 5;
        }

        /* Navigator */
        .navigator-container {
            position: relative;
            height: 24px;
            background: #111;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
            user-select: none;
        }

        .nav-playhead {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.5);
            z-index: 1;
            display: none;
        }

        .nav-window {
            position: absolute;
            top: 1px;
            bottom: 1px;
            background: rgba(255, 202, 40, 0.2);
            border: 1px solid #ffca28;
            box-sizing: border-box;
            z-index: 20;
            cursor: grab;
            min-width: 10px;
        }

        .nav-window:active {
            cursor: grabbing;
            background: rgba(255, 202, 40, 0.3);
        }

        .nav-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 8px;
            background: #ffca28;
            cursor: ew-resize;
            z-index: 30;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-handle::after {
            content: '||';
            font-size: 8px;
            color: #000;
            font-weight: bold;
        }

        .nav-handle.left {
            left: 0;
            border-top-left-radius: 3px;
            border-bottom-left-radius: 3px;
        }

        .nav-handle.right {
            right: 0;
            border-top-right-radius: 3px;
            border-bottom-right-radius: 3px;
        }

        /* Buttons & Layout */
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            background: #444;
            color: white;
            font-size: 11px;
            transition: 0.2s;
        }

        button:hover {
            filter: brightness(1.2);
        }

        .btn-play {
            background: #2e7d32;
        }

        .btn-pause {
            background: #c62828;
        }

        .active-btn {
            background: #00aaff;
            color: white;
            border: 1px solid #fff;
        }

        /* --- NEW PAN & ZOOM CONTROL (Box Style) --- */
        .pan-control-wrapper {
            background: #2b2b2b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 5px;
            border: 1px solid #333;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Vertical Slider Container */
        .v-slider-cont {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100px;
            width: 30px;
        }

        input[type=range].v-slider {
            -webkit-appearance: slider-vertical;
            /* Chrome/Safari/Edge */
            width: 8px;
            height: 80px;
            accent-color: #00aaff;
        }

        /* 16:9 Pan Area */
        .pan-area-cont {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .pan-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #111;
            border: 1px solid #555;
            position: relative;
            overflow: hidden;
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 10px 10px;
        }

        /* The Red Box (Viewport) */
        .pan-viewport {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #ff3333;
            background: rgba(255, 51, 51, 0.2);
            box-sizing: border-box;
            cursor: move;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .pan-viewport:active {
            background: rgba(255, 51, 51, 0.4);
            border-color: #ffaaaa;
        }

        .reset-zoom-btn {
            background: #333;
            color: #aaa;
            font-size: 10px;
            padding: 4px;
            border: 1px solid #444;
        }

        /* Modals */
        .menu-bar {
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #333;
            display: flex;
            gap: 5px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #555;
            color: #ccc;
        }

        .btn-outline:hover {
            background: #333;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal {
            background: #252525;
            width: 90%;
            max-width: 350px;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            color: #ddd;
            transform: translateY(20px);
            transition: 0.3s;
            text-align: center;
        }

        .modal-overlay.open .modal {
            transform: translateY(0);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
        }

        /* Sponsor V1.0 Style + Home */
        .sponsor-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .sponsor-item {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
        }

        .qr-box img {
            width: 100px;
            height: 100px;
            border-radius: 4px;
            display: block;
            margin: 5px auto;
        }

        .sponsor-link {
            display: block;
            color: #00aaff;
            text-decoration: none;
            margin-top: 5px;
            font-size: 11px;
        }

        .copy-group {
            display: flex;
            gap: 5px;
            margin: 10px 0;
        }

        .copy-input {
            flex: 1;
            background: #111;
            border: 1px solid #444;
            color: #00aaff;
            padding: 8px;
            font-size: 11px;
            font-family: monospace;
        }

        #loop-status {
            color: #cc3333;
            font-weight: bold;
            font-size: 11px;
            display: none;
            text-align: center;
            margin-bottom: 5px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>

    <div class="app-header">
        <div class="logo-text">OBS<span>VAR</span> Replay</div>
    </div>

    <div id="video-wrapper">
        <video id="mainVideo" muted playsinline></video>
    </div>

    <div id="controls-ui">
        <input type="file" id="fileInput" accept="video/*" style="display:none;" onchange="handleFileSelect(this)">

        <div id="drop-zone" onclick="document.getElementById('fileInput').click()">
            <div style="font-size:20px;">üìÇ</div>
            <b>‡∏Ñ‡∏•‡∏¥‡∏Å</b> ‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà<br>
            <span style="font-size:10px; color:#666;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ñ‡∏•‡∏¥‡∏õ</span>
        </div>

        <div id="loop-status">‚ö° LOOP A-B ACTIVE ‚ö°</div>

        <div class="timeline-wrapper">
            <div class="timeline-container" id="timelineBox">
                <div class="track-bg"></div>
                <div class="track-fill" id="trackFill"></div>
                <div id="markA" class="marker">
                    <div class="marker-head">A</div>
                </div>
                <div id="markB" class="marker">
                    <div class="marker-head">B</div>
                </div>
                <div class="click-layer" onmousedown="userScrubStart(event)"></div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:10px; color:#888; margin-top:-5px;">
                <span id="currTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>

            <div class="navigator-container" id="navBox">
                <div class="nav-playhead" id="navPlayhead"></div>
                <div class="nav-window" id="navWindow" style="left:0%; width:100%;">
                    <div class="nav-handle left" onmousedown="startNavResize('left', event)"></div>
                    <div class="nav-handle right" onmousedown="startNavResize('right', event)"></div>
                </div>
            </div>
            <div style="text-align:center; font-size:9px; color:#666; margin-top:2px;">Navigator: ‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°
                Timeline</div>
        </div>

        <div class="btn-grid">
            <button class="btn-play" onclick="sendCmd('play')">‚ñ∂ PLAY</button>
            <button class="btn-pause" onclick="sendCmd('pause')">‚è∏ PAUSE</button>
            <button id="btnSetA" onclick="sendCmd('setA')">SET A</button>
            <button id="btnSetB" onclick="sendCmd('setB')">SET B</button>
        </div>
        <button onclick="sendCmd('clearLoop')" style="width:100%; background:#422; margin-bottom:10px; color:#ffaaaa;">‚ùå
            CLEAR LOOP</button>

        <div class="slider-row" style="flex-wrap:wrap;">
            <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:2px;">
                <span>SPEED: <span id="speedVal" style="color:#00aaff; font-weight:bold;">1.0x</span></span>
            </div>
            <input type="range" id="speedRange" min="0.01" max="2.0" step="0.01" value="1.0" style="width:100%"
                oninput="updateSpeed(this.value)">
        </div>

        <div class="pan-control-wrapper">
            <div class="v-slider-cont">
                <span style="font-size:10px; color:#00aaff;">ZOOM</span>
                <input type="range" class="v-slider" id="zoomRange" min="1.0" max="10.0" step="0.1" value="1.0"
                    oninput="updateZoom(this.value)">
                <span id="zoomVal" style="font-size:10px; color:#fff;">1.0x</span>
            </div>

            <div class="pan-area-cont">
                <div class="pan-frame" id="panFrame">
                    <div class="pan-viewport" id="panViewport" onmousedown="startPanDrag(event)"></div>
                </div>
                <button class="reset-zoom-btn" onclick="resetZoom()">‚Ü∫ Reset Zoom & Position</button>
            </div>
        </div>

        <div class="menu-bar">
            <button class="btn btn-outline" style="flex:1;" onclick="openModal('modal-help')">‚ùì Get Link</button>
            <button class="btn btn-outline" style="flex:1; color:#ffca28; border-color:#ffca28;"
                onclick="openModal('modal-sponsor')">üéÅ Sponsor</button>
        </div>
    </div>

    <div id="modal-help" class="modal-overlay" onclick="closeModal(event, 'modal-help')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal(null, 'modal-help')">&times;</button>
            <h2 style="color:#00aaff;">Graphic Link (Screen)</h2>
            <p style="font-size:12px; color:#ccc;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS Browser Source</p>

            <div class="copy-group">
                <input type="text" class="copy-input" id="linkInputScreen"
                    value="https://jamornzmedia.github.io/obs-dock-ui/VAR_Replay_V1.1.html?mode=screen" readonly>
                <button style="background:#005f73; color:white; width:60px; border:none; border-radius:4px;"
                    onclick="copyInput('linkInputScreen')">Copy</button>
            </div>
            <div id="copy-msg" style="font-size:11px; color:#44aa44; opacity:0; transition:0.3s;">Copied!</div>
        </div>
    </div>

    <div id="modal-sponsor" class="modal-overlay" onclick="closeModal(event, 'modal-sponsor')">
        <div class="modal">
            <button class="modal-close" onclick="closeModal(null, 'modal-sponsor')">&times;</button>
            <h2 style="color:#ffca28;">Support Developer</h2>

            <div class="sponsor-grid">
                <div class="sponsor-item">
                    <span style="color:#fff; font-weight:bold;">Thai Bank / PromptPay</span>
                    <div class="qr-box"><img
                            src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://easydonate.app/Jamornz"
                            alt="QR"></div>
                    <a href="https://easydonate.app/Jamornz" target="_blank"
                        class="sponsor-link">easydonate.app/Jamornz</a>
                </div>

                <div class="sponsor-item"
                    style="background:#111; border:1px solid #555; display:flex; flex-direction:column; justify-content:center;">
                    <span style="color:#fff; font-weight:bold; font-size:14px;">üè† Home</span>
                    <a href="https://sites.google.com/view/jamornzmedia" target="_blank" class="sponsor-link"
                        style="font-size:12px; color:#ffca28; margin-top:10px;">Visit JamornzMedia</a>
                </div>
            </div>

            <div style="margin-top:20px; font-size:10px; color:#666;">Developed by <b>JamornzMedia</b> V1.1</div>
        </div>
    </div>

    <script>
        const channel = new BroadcastChannel('jamorn_var_v1_final');
        const video = document.getElementById('mainVideo');
        const dropZone = document.getElementById('drop-zone');
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        let isScrubbing = false;
        let loopA = null, loopB = null;

        // Init Mode
        if (mode === 'screen') {
            document.body.classList.add('screen-mode');
            initScreen();
        } else {
            document.body.classList.add('control-mode');
            initControl();
        }

        // --- Utils ---
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(e, id) { if (e && e.target !== e.currentTarget) return; document.getElementById(id).classList.remove('open'); }
        function copyInput(id) {
            const el = document.getElementById(id);
            el.select(); el.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(el.value);
            document.getElementById('copy-msg').style.opacity = '1';
            setTimeout(() => document.getElementById('copy-msg').style.opacity = '0', 2000);
        }

        // ==========================================
        // üéÆ CONTROL LOGIC (DOCK)
        // ==========================================

        // --- NAVIGATOR VARS ---
        let viewStart = 0, viewWidth = 1, globalDuration = 1;

        // --- PAN/ZOOM VARS ---
        let currentZoom = 1.0;
        let panX_pct = 0; // 0 = Center. Range depends on zoom. 
        let panY_pct = 0;
        // NOTE: We will track "Viewport Position" in % (0-100) relative to frame
        // VP Left: 0% = Left Edge. 
        let vpLeft = 0;
        let vpTop = 0;

        function initControl() {
            // Drag Drop
            dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('hover'); };
            dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('hover'); };
            dropZone.ondrop = e => {
                e.preventDefault(); dropZone.classList.remove('hover');
                if (e.dataTransfer.files[0]) loadFile(e.dataTransfer.files[0]);
            };

            // Listen from Screen
            channel.onmessage = e => {
                const msg = e.data;
                if (msg.type === 'status') {
                    globalDuration = msg.durSec;
                    if (!isScrubbing) updateTimelineVisuals(msg.currSec, msg.posA, msg.posB);

                    document.getElementById('currTime').innerText = msg.currFmt;
                    document.getElementById('totalTime').innerText = msg.totalFmt;
                    document.getElementById('btnSetA').className = msg.hasA ? 'active-btn' : '';
                    document.getElementById('btnSetB').className = msg.hasB ? 'active-btn' : '';
                    document.getElementById('loop-status').style.display = (msg.hasA && msg.hasB) ? 'block' : 'none';

                    const navPct = (msg.currSec / msg.durSec) * 100;
                    const navHead = document.getElementById('navPlayhead');
                    navHead.style.display = 'block'; navHead.style.left = navPct + '%';
                }
            };
        }

        function handleFileSelect(input) { if (input.files && input.files[0]) loadFile(input.files[0]); }

        function loadFile(f) {
            dropZone.innerHTML = `<span style="color:#00aaff">Loading...</span>`;
            const r = new FileReader();
            r.onload = evt => {
                let mime = f.type || 'video/mp4';
                if (f.name.toLowerCase().endsWith('.mkv')) mime = 'video/webm';
                channel.postMessage({ type: 'file', data: evt.target.result, mime: mime });
                dropZone.innerHTML = `<span style="color:#44aa44">Ready: ${f.name}</span>`;
                resetZoom();
                viewStart = 0; viewWidth = 1; updateNavUI();
                document.getElementById('speedRange').value = 1.0;
                document.getElementById('speedVal').innerText = "1.0x";
            };
            r.readAsArrayBuffer(f);
        }

        // --- NEW PAN & ZOOM LOGIC ---
        function updateZoom(val) {
            currentZoom = parseFloat(val);
            document.getElementById('zoomVal').innerText = currentZoom.toFixed(1) + "x";

            updateViewportSize();
            // Constraint Check: If zooming out puts viewport out of bounds, fix it
            clampViewport();
            updateViewportVisuals();
            sendTransform();
        }

        function updateViewportSize() {
            // Viewport size is inversely proportional to zoom
            // Zoom 1x -> VP 100%
            // Zoom 2x -> VP 50%
            const vpW = 100 / currentZoom;
            const vpH = 100 / currentZoom;
            const el = document.getElementById('panViewport');
            el.style.width = vpW + "%";
            el.style.height = vpH + "%";
        }

        let isPanDrag = false;
        let panStartX, panStartY;
        let panStartLeft, panStartTop;

        function startPanDrag(e) {
            e.preventDefault();
            if (currentZoom <= 1.01) return; // Cannot pan if not zoomed
            isPanDrag = true;
            panStartX = e.clientX;
            panStartY = e.clientY;
            const el = document.getElementById('panViewport');
            // Parse current % left/top
            panStartLeft = parseFloat(el.style.left) || 0;
            panStartTop = parseFloat(el.style.top) || 0;

            window.addEventListener('mousemove', onPanDrag);
            window.addEventListener('mouseup', endPanDrag);
        }

        function onPanDrag(e) {
            if (!isPanDrag) return;
            const frame = document.getElementById('panFrame').getBoundingClientRect();

            const dxPx = e.clientX - panStartX;
            const dyPx = e.clientY - panStartY;

            // Convert px delta to % delta
            const dxPct = (dxPx / frame.width) * 100;
            const dyPct = (dyPx / frame.height) * 100;

            vpLeft = panStartLeft + dxPct;
            vpTop = panStartTop + dyPct;

            clampViewport();
            updateViewportVisuals();
            sendTransform();
        }

        function endPanDrag() {
            isPanDrag = false;
            window.removeEventListener('mousemove', onPanDrag);
            window.removeEventListener('mouseup', endPanDrag);
        }

        function clampViewport() {
            const vpSize = 100 / currentZoom;
            const maxLeft = 100 - vpSize;
            const maxTop = 100 - vpSize;

            if (vpLeft < 0) vpLeft = 0;
            if (vpLeft > maxLeft) vpLeft = maxLeft;

            if (vpTop < 0) vpTop = 0;
            if (vpTop > maxTop) vpTop = maxTop;
        }

        function updateViewportVisuals() {
            const el = document.getElementById('panViewport');
            el.style.left = vpLeft + "%";
            el.style.top = vpTop + "%";
        }

        function resetZoom() {
            currentZoom = 1.0;
            vpLeft = 0; vpTop = 0;
            document.getElementById('zoomRange').value = 1.0;
            document.getElementById('zoomVal').innerText = "1.0x";
            updateViewportSize();
            updateViewportVisuals();
            sendTransform();
        }

        function sendTransform() {
            // Calculate Translate based on Viewport Position
            // If VP is centered, Translate is 0.
            // If VP is Left, Image must shift Right (Positive Translate).
            // Logic: Translate% = (CenterOfVP - CenterOfFrame) * -Zoom? 

            // Easier way: Map VP position (0 to Max) to Transform Range.
            // When Zoom=2: VP size=50%. Max Move=50%.
            // If VP at 0% (Left), we want to see Left side.
            // To see Left side at Scale 2, Translate X must be +25% (of image size).
            // Formula: Translate% = (0.5 - CenterOfViewPort%) * Zoom * 100? No.

            // Let's use standard transform-origin center logic.
            // Translate X (in %) = (50 - CenterOfViewportX) * (Zoom / 100?? No)

            // Let's calculate Center of Viewport in % (0-100)
            const vpSize = 100 / currentZoom;
            const centerVpX = vpLeft + (vpSize / 2); // 0 to 100
            const centerVpY = vpTop + (vpSize / 2);  // 0 to 100

            // Deviation from center (50)
            const devX = 50 - centerVpX; // If left (e.g. 25), result +25.
            const devY = 50 - centerVpY;

            // When we Scale, the image grows from center.
            // To bring "25%" to the center, we need to shift.
            // It turns out: translate(x%, y%) works directly with the deviation if mapped correctly.
            // Actually, for scale Z, the visible area is 1/Z.
            // The shift required is devX * Z ?? No.

            // Simple mapping that works for CSS Scale Center:
            // Translate% = Deviation%
            // But we need to account for the fact that 1% translate moves 1% of the *image width*.

            sendCmd('transform', { z: currentZoom, x: devX, y: devY });
        }

        // --- TIMELINE & NAVIGATOR (Reused from Revised) ---
        function timeToUiPct(timeSec) {
            if (globalDuration <= 0) return 0;
            let totalPct = timeSec / globalDuration;
            if (totalPct < viewStart || totalPct > viewStart + viewWidth) return -10;
            return ((totalPct - viewStart) / viewWidth) * 100;
        }
        function uiPctToTime(uiPct) {
            let localRatio = uiPct / 100;
            return (viewStart + (localRatio * viewWidth)) * globalDuration;
        }
        function updateTimelineVisuals(currSec, timeA, timeB) {
            let fillPct = timeToUiPct(currSec);
            fillPct = Math.max(0, Math.min(100, fillPct));
            document.getElementById('trackFill').style.width = fillPct + "%";
            setMarker('markA', timeA); setMarker('markB', timeB);
        }
        function setMarker(id, timeVal) {
            const el = document.getElementById(id);
            if (timeVal !== null) {
                let pct = timeToUiPct(timeVal);
                if (pct >= 0 && pct <= 100) { el.style.display = 'block'; el.style.left = pct + '%'; }
                else { el.style.display = 'none'; }
            } else { el.style.display = 'none'; }
        }
        function userScrubStart(e) {
            isScrubbing = true; scrubMove(e);
            window.addEventListener('mousemove', scrubMove); window.addEventListener('mouseup', scrubEnd);
        }
        function scrubMove(e) {
            const box = document.getElementById('timelineBox').getBoundingClientRect();
            let x = e.clientX - box.left;
            let pct = Math.max(0, Math.min(100, (x / box.width) * 100));
            document.getElementById('trackFill').style.width = pct + "%";
            sendCmd('seek', uiPctToTime(pct));
        }
        function scrubEnd() {
            isScrubbing = false; window.removeEventListener('mousemove', scrubMove); window.removeEventListener('mouseup', scrubEnd);
        }

        function updateNavUI() {
            const win = document.getElementById('navWindow');
            win.style.left = (viewStart * 100) + "%";
            win.style.width = (viewWidth * 100) + "%";
        }
        let isNavResizing = false; let navAction = null; let navStartX = 0, navStartView = 0, navStartWidth = 0;
        function startNavResize(action, e) {
            e.stopPropagation(); e.preventDefault();
            isNavResizing = true; navAction = action; navStartX = e.clientX; navStartView = viewStart; navStartWidth = viewWidth;
            window.addEventListener('mousemove', onNavDrag); window.addEventListener('mouseup', endNavDrag);
        }
        document.getElementById('navWindow').addEventListener('mousedown', function (e) {
            if (e.target.classList.contains('nav-handle')) return;
            startNavResize('move', e);
        });
        function onNavDrag(e) {
            if (!isNavResizing) return;
            const box = document.getElementById('navBox').getBoundingClientRect();
            const deltaPct = (e.clientX - navStartX) / box.width;
            if (navAction === 'move') {
                let newStart = navStartView + deltaPct;
                if (newStart < 0) newStart = 0; if (newStart + navStartWidth > 1) newStart = 1 - navStartWidth;
                viewStart = newStart;
            } else if (navAction === 'left') {
                let newStart = navStartView + deltaPct; let newWidth = navStartWidth - deltaPct;
                if (newWidth < 0.05) { newStart = navStartView + navStartWidth - 0.05; newWidth = 0.05; }
                if (newStart < 0) { newStart = 0; newWidth = navStartView + navStartWidth; }
                viewStart = newStart; viewWidth = newWidth;
            } else if (navAction === 'right') {
                let newWidth = navStartWidth + deltaPct;
                if (newWidth < 0.05) newWidth = 0.05; if (viewStart + newWidth > 1) newWidth = 1 - viewStart;
                viewWidth = newWidth;
            }
            updateNavUI();
        }
        function endNavDrag() { isNavResizing = false; window.removeEventListener('mousemove', onNavDrag); window.removeEventListener('mouseup', endNavDrag); }

        function sendCmd(act, val = null) { channel.postMessage({ type: 'cmd', act, val }); }
        function updateSpeed(val) { document.getElementById('speedVal').innerText = val + "x"; sendCmd('speed', val); }

        // ==========================================
        // üì∫ SCREEN LOGIC (OBS)
        // ==========================================
        function initScreen() {
            video.muted = true;
            channel.onmessage = e => {
                const msg = e.data;
                if (msg.type === 'file') {
                    const blob = new Blob([msg.data], { type: msg.mime });
                    video.src = URL.createObjectURL(blob);
                    loopA = null; loopB = null; resetVideoTransform();
                    video.loop = true; video.playbackRate = 1.0; video.play();
                }
                if (msg.type === 'cmd') {
                    switch (msg.act) {
                        case 'play': video.play(); break;
                        case 'pause': video.pause(); break;
                        case 'speed': video.playbackRate = msg.val; break;
                        case 'seek': video.currentTime = msg.val; break;
                        case 'setA': loopA = video.currentTime; break;
                        case 'setB': loopB = video.currentTime; if (loopB < loopA) { let t = loopA; loopA = loopB; loopB = t; } break;
                        case 'clearLoop': loopA = null; loopB = null; break;
                        case 'transform': applyTransform(msg.val); break;
                    }
                }
            };
            video.ontimeupdate = () => {
                if (!video.duration) return;
                if (loopA !== null && loopB !== null) {
                    if (video.currentTime >= loopB || video.currentTime < loopA) {
                        video.currentTime = loopA; if (video.paused) video.play();
                    }
                }
                channel.postMessage({
                    type: 'status', durSec: video.duration, currSec: video.currentTime,
                    currFmt: fmt(video.currentTime), totalFmt: fmt(video.duration),
                    hasA: loopA !== null, hasB: loopB !== null, posA: loopA, posB: loopB
                });
            };
        }

        function applyTransform(t) {
            // t.x and t.y are "Deviation from Center" percentages.
            // Positive t.x means Viewport is Left, so we shift image Right (Positive).
            video.style.transform = `scale(${t.z}) translate(${t.x}%, ${t.y}%)`;
        }
        function resetVideoTransform() { video.style.transform = `scale(1) translate(0%, 0%)`; }
        function fmt(s) { let m = Math.floor(s / 60), sc = Math.floor(s % 60); return m + ":" + (sc < 10 ? "0" : "") + sc; }

    </script>
</body>

</html>