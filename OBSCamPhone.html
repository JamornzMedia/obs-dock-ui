<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OBS Cam Sender</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
            font-family: sans-serif;
        }

        .video-full {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>

<body>

    <div id="setup" class="p-8 flex flex-col h-screen justify-center bg-slate-950">
        <div class="text-center mb-10">
            <div class="inline-block p-4 bg-blue-600/20 rounded-full mb-4">
                <i class="fas fa-camera text-4xl text-blue-500"></i>
            </div>
            <h1 class="text-2xl font-bold text-white uppercase tracking-widest">Sender Unit</h1>
            <p class="text-gray-500 text-xs mt-1">ส่งภาพไร้สายไปยัง OBS</p>
        </div>

        <div class="space-y-5">
            <div>
                <label class="text-[10px] text-blue-400 font-bold uppercase ml-1 mb-1 block">Target Room ID</label>
                <input type="tel" id="room-id" placeholder="######" maxlength="6"
                    class="w-full bg-black border border-slate-800 p-4 rounded-2xl text-center text-4xl font-mono text-white focus:border-blue-600 focus:ring-1 focus:ring-blue-600 outline-none transition-all">
            </div>

            <div>
                <label class="text-[10px] text-gray-400 font-bold uppercase ml-1 mb-1 block">Resolution</label>
                <select id="res"
                    class="w-full bg-slate-900 border border-slate-800 p-4 rounded-2xl text-white outline-none">
                    <option value="1080">Full HD (1080p)</option>
                    <option value="720">HD (720p)</option>
                    <option value="480">SD (480p)</option>
                </select>
            </div>

            <button onclick="startStreaming()"
                class="w-full bg-blue-600 hover:bg-blue-500 py-5 rounded-2xl font-bold text-xl shadow-xl active:scale-95 transition-all">
                START STREAMING
            </button>
        </div>
    </div>

    <div id="live-ui" class="hidden absolute inset-0 bg-black">
        <video id="preview" class="video-full" autoplay playsinline muted></video>

        <div
            class="absolute top-6 left-6 flex items-center gap-3 bg-black/60 backdrop-blur-md p-2 px-4 rounded-full border border-white/10">
            <div class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></div>
            <span id="bitrate-display" class="font-mono text-xs font-bold uppercase">0 kbps</span>
        </div>

        <button onclick="location.reload()"
            class="absolute top-6 right-6 bg-red-600/90 w-10 h-10 rounded-full flex items-center justify-center shadow-lg">
            <i class="fas fa-times"></i>
        </button>

        <div class="absolute bottom-10 left-0 w-full flex justify-center gap-10">
            <button onclick="toggleTorch()" id="torch-btn"
                class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center transition-all">
                <i class="fas fa-bolt text-2xl text-white"></i>
            </button>
            <button onclick="triggerAutoFocus()"
                class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center transition-all">
                <i class="fas fa-crosshairs text-2xl text-white"></i>
            </button>
        </div>
    </div>

    <script>
        let peer, myStream, videoTrack;

        // จดจำค่าล่าสุดจาก localStorage
        window.onload = () => {
            const savedRoom = localStorage.getItem('obs_last_room');
            const savedRes = localStorage.getItem('obs_last_res');
            if (savedRoom) document.getElementById('room-id').value = savedRoom;
            if (savedRes) document.getElementById('res').value = savedRes;
        };

        async function startStreaming() {
            const rid = document.getElementById('room-id').value;
            const resHeight = parseInt(document.getElementById('res').value);

            if (rid.length < 6) return alert('กรุณาใส่ Room ID 6 หลัก');

            // บันทึกค่าลงเครื่อง
            localStorage.setItem('obs_last_room', rid);
            localStorage.setItem('obs_last_res', resHeight);

            try {
                myStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: resHeight * 1.777 }, // 16:9
                        height: { ideal: resHeight },
                        frameRate: { ideal: 30 }
                    },
                    audio: true
                });

                videoTrack = myStream.getVideoTracks()[0];
                document.getElementById('preview').srcObject = myStream;
                document.getElementById('setup').classList.add('hidden');
                document.getElementById('live-ui').classList.remove('hidden');

                peer = new Peer(); // สุ่มไอดีฝั่งส่ง
                peer.on('open', () => {
                    const call = peer.call('obs-receiver-' + rid, myStream);
                    monitorBitrate(call.peerConnection);
                });

                peer.on('error', (err) => {
                    console.error(err);
                    alert('Connection Error. Please check Room ID.');
                    location.reload();
                });

            } catch (e) {
                alert('Camera Error: ' + e.message);
            }
        }

        function monitorBitrate(pc) {
            let lastB = 0, lastT = 0;
            setInterval(async () => {
                if (!pc) return;
                const stats = await pc.getStats();
                stats.forEach(report => {
                    if (report.type === 'outbound-rtp' && report.kind === 'video') {
                        const now = report.timestamp;
                        const bitrate = Math.round(((report.bytesSent - lastB) * 8) / (now - lastT));
                        document.getElementById('bitrate-display').innerText = bitrate + " kbps";
                        lastB = report.bytesSent; lastT = now;
                    }
                });
            }, 1000);
        }

        async function toggleTorch() {
            if (!videoTrack) return;
            const caps = videoTrack.getCapabilities();
            if (!caps.torch) return;

            const current = videoTrack.getSettings().torch;
            try {
                await videoTrack.applyConstraints({ advanced: [{ torch: !current }] });
                document.getElementById('torch-btn').classList.toggle('bg-yellow-500/50');
            } catch (e) { console.error(e); }
        }

        async function triggerAutoFocus() {
            if (!videoTrack) return;
            try {
                await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
            } catch (e) { }
        }
    </script>
</body>

</html>